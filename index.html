<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title id="main-title">ÛŒØ§Ø±ÛŒ ÙÛÚµØ¨Ø§Ø² (Imposter)</title>
 <script src="https://cdn.tailwindcss.com"></script>
 
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
 <script>
     tailwind.config = {
         theme: {
             extend: {
                 colors: {
                     'primary': '#facc15',
                     'secondary': '#6366f1',
                     'dark-bg': '#1e293b',
                     'dark-card': '#334155',
                     'input-bg': '#475569',
                 },
                 fontFamily: {
                     'kurdish': ['Scheherazade New', 'sans-serif'],
                 }
             }
         }
     }
 </script>
 <style>
     @import url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap');

     body {
         background-color: #0f172a;
         background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
         background-size: 40px 40px;
         background-position: 0 0, 20px 20px;
         display: flex;
         justify-content: center;
         align-items: center;
         min-height: 100vh;
         padding: 20px;
         font-family: 'kurdish';
     }

     .card {
         background-color: var(--dark-card);
         border-radius: 1.5rem;
         padding: 2.5rem 1.5rem;
         box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
         max-width: 420px;
         width: 100%;
         margin-top: 20px;
         margin-bottom: 20px;
     }

     .title-bar {
         border-bottom: 2px solid rgba(255, 255, 255, 0.1);
         padding-bottom: 0.75rem;
         margin-bottom: 1.5rem;
     }

     input[type="number"], input[type="text"], .input-text-area {
         background-color: var(--input-bg);
         color: #f8fafc;
         border: 1px solid #475569;
         border-radius: 0.5rem;
         padding: 0.5rem 0.75rem;
         width: 100%;
         margin-bottom: 0.75rem;
         text-align: right;
     }

     .primary-btn {
         background: linear-gradient(145deg, #facc15, #eab308);
         color: #1e293b;
         font-weight: 700;
         padding: 0.75rem 1.5rem;
         border-radius: 0.75rem;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.15);
         transition: all 0.2s;
         width: 100%;
     }

     .primary-btn:hover {
         opacity: 0.9;
         transform: translateY(-1px);
         box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
     }
     
     .secondary-btn {
        background: linear-gradient(145deg, #6366f1, #4f46e5);
        color: white;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.15);
        transition: all 0.2s;
        width: 100%;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
     }

     .secondary-btn:hover {
         opacity: 0.9;
         transform: translateY(-1px);
         box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
     }
     
     .back-btn {
         background-color: transparent;
         border: 2px solid #94a3b8;
         color: #94a3b8;
         font-weight: 500;
         padding: 0.5rem 1rem;
         border-radius: 0.5rem;
         transition: all 0.2s;
         width: 100%;
         margin-top: 1rem;
     }
     .back-btn:hover {
        background-color: #334155;
        color: #f8fafc;
     }
     
     .lobby-player-item {
         display: flex;
         justify-content: space-between;
         align-items: center;
         background-color: #475569;
         padding: 0.5rem 1rem;
         border-radius: 0.5rem;
         margin-bottom: 0.5rem;
         color: #f8fafc;
         font-size: 1rem;
     }
     .lobby-player-item.creator {
         border: 2px solid #facc15;
     }
     .lobby-player-item .status {
         font-size: 0.875rem;
         color: #94a3b8;
     }
     .lobby-player-item .status.ready {
         color: #34d399;
         font-weight: 700;
     }
     
     .lobby-player-item .remove-btn {
         background-color: #f87171;
         color: white;
         border: none;
         border-radius: 0.25rem;
         padding: 0.25rem 0.5rem;
         cursor: pointer;
         font-size: 0.75rem;
         font-weight: 700;
         transition: background-color 0.2s;
         margin-right: 0.5rem;
     }
     .lobby-player-item .remove-btn:hover {
         background-color: #ef4444;
     }


     .player-card {
         background-color: #475569;
         border: 1px solid #64748b;
         padding: 20px;
         border-radius: 1rem;
         margin-top: 1.5rem;
         text-align: center;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
         transition: all 0.3s;
     }
   
     .player-card:hover {
         transform: scale(1.02);
     }

     .word-civilian {
         color: #34d399;
     }
     .word-imposter {
         color: #f87171;
     }

     .role-text {
         font-size: 1.5rem;
         font-weight: 700;
         color: var(--primary);
         margin-bottom: 10px;
     }
     .role-text-simplified {
         font-size: 2rem;
         font-weight: 700;
         margin-bottom: 0;
     }

     .word-text {
         font-size: 1.25rem;
         color: #f8fafc;
     }
   
     .footer-text {
         margin-top: 2rem;
         text-align: center;
         font-size: 0.8rem;
         color: #94a3b8;
     }
   
     .footer-text a {
         color: var(--primary);
         text-decoration: none;
         margin-right: 5px;
         margin-left: 5px;
     }
     .footer-text a:hover {
         text-decoration: underline;
     }

     #custom-modal {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.7);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 1000;
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s, visibility 0.3s;
         overflow-y: auto;
     }
     #custom-modal.show {
         opacity: 1;
         visibility: visible;
     }
     .modal-content {
         background-color: var(--dark-card);
         margin: 5% auto; 
         padding: 2rem;
         border-radius: 1rem;
         max-width: 350px;
         width: 90%;
         color: #f8fafc;
         text-align: center;
         box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
         transform: translateY(-50px);
         transition: transform 0.3s;
         max-height: 90vh;
         overflow-y: auto;
         position: relative;
     }
     #custom-modal.show .modal-content {
         transform: translateY(0);
     }
     .modal-title {
         font-size: 1.5rem;
         font-weight: 700;
         color: #facc15;
         margin-bottom: 0.75rem;
     }
     .imposter-popup .modal-title {
        color: #f87171;
        font-size: 2rem;
     }
     .imposter-popup .modal-message {
        font-size: 1.5rem;
        font-weight: bold;
        color: #facc15;
     }
     .modal-message {
         margin-bottom: 1.5rem;
         font-size: 1rem;
         text-align: right;
     }
     .modal-message strong {
         color: #facc15;
     }
     
     .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px; 
        font-size: 1.5rem;
        background: none;
        border: none;
        color: #f8fafc;
        cursor: pointer;
        line-height: 1;
        padding: 5px;
     }
     .rtl .modal-close-btn {
        right: 10px;
        left: auto;
     }
     
     #room-code-display {
         font-family: 'Roboto', monospace;
         font-size: 2.5rem;
         font-weight: 900;
         color: #facc15;
         letter-spacing: 0.2rem;
         margin: 1rem 0;
         text-align: center;
         user-select: all;
     }
     #room-code-label {
         color: #94a3b8;
         font-weight: 700;
         font-size: 1.1rem;
     }
     
     .share-button {
         position: fixed;
         bottom: 20px;
         right: 20px;
         background-color: var(--secondary);
         color: white;
         border: none;
         border-radius: 50%;
         width: 50px;
         height: 50px;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
         z-index: 1000;
         transition: background-color 0.2s, transform 0.2s;
     }
     .share-button:hover {
         background-color: #4f46e5;
         transform: scale(1.05);
     }

     .help-button {
         position: fixed;
         bottom: 20px;
         right: 90px;
         background-color: #34d399;
         color: #1e293b;
         border: none;
         border-radius: 50%;
         width: 50px;
         height: 50px;
         font-size: 1.5rem;
         font-weight: bold;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
         z-index: 1000;
         transition: background-color 0.2s, transform 0.2s;
     }
     .help-button:hover {
         background-color: #10b981;
         transform: scale(1.05);
     }
 </style>
</head>
<body class="rtl" style="--dark-card: #334155; --input-bg: #475569; --primary: #facc15; --secondary: #6366f1;">

 <div id="game-container" class="card">
     </div>

 <div id="custom-modal">
     <div class="modal-content" id="modal-inner">
         </div>
 </div>

 <button id="shareButton" class="share-button" onclick="shareGameLink()">
     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
 </button>

 <button id="helpButton" class="help-button" onclick="showHelpModal()">
    ?
 </button>


 <script>
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", 
        authDomain: "kigbynaseh.firebaseapp.com",
        databaseURL: "https://kigbynaseh-default-rtdb.firebaseio.com",
        projectId: "kigbynaseh",
        storageBucket: "kigbynaseh.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    const modal = document.getElementById('custom-modal');
    const modalInner = document.getElementById('modal-inner');
    const shareButton = document.getElementById('shareButton');
    const helpButton = document.getElementById('helpButton');

    let database;
    let roomRef;
    let myPlayerId = null;

    const WORDS_KU = [
        "Ù¾Ø²ÛŒØ´Ú©", "Ù…Ø§Ù…Û†Ø³ØªØ§", "Ø¦Û•Ù†Ø¯Ø§Ø²ÛŒØ§Ø±", "ÙÛ•Ø±Ù…Ø§Ù†Ø¨Û•Ø±", "Ø´Û†ÙÛØ±", "Ú¯Û†Ø±Ø§Ù†ÛŒØ¨ÛÚ˜", "Ù†ÙˆÙˆØ³Û•Ø±", "ÙˆÛ•Ø±Ú¯ÛÚ•",
        "Ú©Ø§Ø³Ø¨Ú©Ø§Ø±", "ÙˆÛÙ†Û•Ú©ÛØ´", "Ø¨Ø§Ø®Ú†Û•ÙˆØ§Ù†", "Ù†Ø§Ù†Û•ÙˆØ§", "Ú¯Û•Ø´ØªÛŒØ§Ø±", "ÙˆÛ•Ø±Ø²Ø´Ú©Ø§Ø±", "ÙØ±Û†Ø´ÛŒØ§Ø±", "Ù¾Û†Ù„ÛŒØ³",
        "Ø³Û•Ø±Ø¨Ø§Ø²", "Ø¦Ø§Ú¯Ø±Ú©ÙˆÚ˜ÛÙ†Û•Ø±", "Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†", "Ú•Û†Ú˜Ù†Ø§Ù…Û•Ù†ÙˆÙˆØ³", "Ø¬ÙˆÙˆØªÛŒØ§Ø±", "Ù¾Ø§Ø³Û•ÙˆØ§Ù†", "Ù‚Û•Ø´Û•", "Ú•Ø§ÙˆÚ†ÛŒ", "Ø´ÙˆØ§Ù†", 
        "Ø³Û•Ú¯", "Ù¾Ø´ÛŒÙ„Û•", "Ú©ÙˆØªØ±", "ÙˆØ±Ú†", "Ú¯ÙˆØ±Ú¯", "Ø¦Ø§Ø³Ú©", "Ú•ÛÙˆÛŒ", "Ø´ÛØ±", "Ù†Û•Ù‡Û•Ù†Ú¯", "Ø¦Û•Ø³Ù¾", "Ø´Û•Ù…Ø´Û•Ù…Û•Ú©ÙˆÛØ±Û•",
        "Ø³Ù…Û†Ø±Û•", "ÙÛŒÙ„", "Ù…Û•ÛŒÙ…ÙˆÙˆÙ†", "Ú†ÛŒÙ…Ù¾Ø§Ù†Ø²ÛŒ", "Ú©Û•Ø±", "Ù…Û•ÛŒÙ…ÙˆÙ†", "Ù‚Û•Ù„Û•Ú•Û•Ø´", "Ù¾Û•Ù¾ÙˆÙ„Û•", "Ù…Ø±ÛŒØ´Ú©", "Ù‚Ø§Ø²", "Ù…Û•Ø±",
        "Ù…Ø§Ø±", "Ù…Ø§Ø±Ù…ÛÙ„Ú©Û•", "Ù‚Û•Ù„", "Ú©ÛŒØ³Û•Úµ", "ØªÙ…Ø³Ø§Ø­", "Ø¨Û†Ù‚", "Ù…Ø§Ø³ÛŒ", "Ù‚Ø±Ø´", "Ø¦Û•Ø®ØªÛ•Ø¨ÙˆØª", "Ø²Û•Ø±Ø§ÙÛ•", "Ø¯Û†Ù„ÙÛŒÙ†", 
        "Ø®Ø§Ù„Ø®Ø§Ù„ÙˆÚ©Û•", "Ù…ÛØ±ÙˆÙ„Û•", "Ù…ÛØ´", "Ú©ÛÙˆØ±ÛŒØ´Ú©", "Ú©ÙˆÙˆÙ„Û•", "Ø¯ÙˆÙˆÙ¾Ø´Ú©", "Ù…Ø´Ú©", "Ø´ÛŒØ±", "Ù¾ÚµÙ†Ú¯", "Ú©ÙˆØªØ±",
        "Ø¯Ø§Ø±", "Ú¯ÙˆÚµ", "Ù†Ø§Ù†", "Ù…ÛŒÙˆÛ•", "Ø³Û•ÙˆØ²Û•", "Ø´Ø§Ù‡", "Ø¦ÛŒÙ…Ø§Ù…", "Ù¾Û", "Ø¯Û•Ø³Øª", "Ú•Û•Ú¯", "Ø¦Û•Ø³ØªÛØ±Û•", 
        "Ø±ÛŒÙˆÛŒ", "Ú¯Û•ÚµØ§", "ØªÛ•Ù…Ø§ØªÛ•", "Ø®Û•ÛŒØ§Ø±", "Ù¾ÛŒØ§Ø²", "Ø³ÛŒØ±", "Ù‚Ø§Ø±Ú†Ú©", "Ù…Û†Ø²", "ÙÛ•Ú•Ù†", "ØªÙˆÙˆ", "Ú¯Ú˜ÙˆÚ¯ÛŒØ§", "Ú¯Û•Ù†Ù…", "Ú¯Û•Ù†Ù…Û•Ø´Ø§Ù…ÛŒ",
        "Ù¾Ù„Û•ÛŒ Ø³ØªÛ•ÛŒØ´Ù†", "Ø²Ø§Ù†Ø§", "Ù¾Û•ØªØ§ØªÛ•", "Ú†Ø§ÛŒ", "Ù‚Ø§ÙˆÛ•", "Ø´ÛŒØ±", "Ù‡Û•Ù†Ú¯ÙˆÛŒÙ†", "Ø²Û•ÛŒØªÙˆÙˆÙ†", "Ø±ÙˆØ¨Ø§Ø±", "Ø³Ø±ÙˆØ´Øª", 
        "Ú†ÛŒØ§", "Ø¯Ø§Ø±Ø³ØªØ§Ù†", "Ø¯Û•Ø±ÛŒØ§", "Ú¯ÙˆÙ†Ø¯", "Ø´Ø§Ø±", "Ù…Ø§Úµ", "Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•", "Ø²Ø§Ù†Ú©Û†", "Ú©Ø§Ø±Ú¯Û•", "Ù…Û†Ø²Û•Ø®Ø§Ù†Û•", "Ø¨ÛŒØ§Ø¨Ø§Ù†",
        "Ø³ÛŒÙ†Û•Ù…Ø§", "Ù…Ø²Ú¯Û•ÙˆØª", "Ø­Û•ÙˆØ´", "Ù‚Ù†ÛŒÙ†Û•", "Ù‚Û•ÚµØ§", "Ø´Û•Ù‚Ø§Ù…", "Ù‡ÙˆØ±Ù†", "ØªØ§ØªÙˆ", "Ú˜Û•Ù‡Ø±", "Ú©Ø§Ù†ÛŒ",
        "Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„", "ÙÚ•Û†Ú©Û•", "Ø´Û•Ù…Û•Ù†Ø¯Û•ÙÛ•Ø±", "Ù¾Ø§Ø³Ú©ÛŒÙ„", "Ú¯ÙˆØ±Ú¯", "Ø±ÙˆÚ˜", "Ù‡Ø§ÙˆÚ•Û", "Ø¯Ø±Ø§ÙˆØ³Û", "Ø­ÙˆØ´ØªØ±",
        "Ú©Û•Ù…Ù¾ÛŒ Ù¾Û•Ù†Ø§Ø¨Û•Ø±Ø§Ù†", "Ù†Ø§ÙˆÚ†Û•", "Ø´Ø§Ø±", "Ù¾Ø§ÛŒØªÛ•Ø®Øª", "Ú¯Û•Ø±Ø§Ø¬", "Ø¨Ø§Ø²Ø§Ú•", "Ø¯ÙˆÚ©Ø§Ù†", "Ù‚Ø§ÙˆÛ•Ø®Ø§Ù†Û•", "Ú©ØªÛØ¨ÙØ±Û†Ø´",
        "Ù¾ÛÙ„ÛŒ Ø¯Û•Ø±ÛŒØ§", "Ú©Ø±ÛŒØ³ØªÛŒØ§Ù†Ùˆ", "Ù‡Û•ØªØ§Ùˆ", "Ú¯ÙˆØ±Ø¨Û•", "Ú¯Ú•Ú©Ø§Ù†", "Ú¯Û•Ù†Ø¬ÛŒÙ†Û•", "Ø¯Û•Ø±Ú¯Ø§", "Ù¾Û•Ù†Ø¬Û•Ø±Û•", "Ù…Ø±ÛŒØ´Ú©",
        "Ù¾Û•Ø±Ø³ÛŒÙˆ", "Ø¦Ø§Ùˆ", "Ù‡Û•ÙˆØ±", "Ø¨Ø§Ø±Ø§Ù†", "Ø¨Û•ÙØ±", "Ø´ÛØ±Ù¾Û•Ù†Ø¬Û•", "Ù…Ø§Ù†Ú¯", "Ø¦Û•Ø³ØªÛØ±Û•", "Ú©ØªÛØ¨", "Ù‚Û•ÚµÛ•Ù…", "Ù„Ø§Ù¾Û•Ú•Û•",
        "Ù…Û†Ø¨Ø§ÛŒÙ„", "Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±", "Ù¾ÛŒØ§Ù†Ùˆ", "Ø¦Û•Ù‚Ù„", "Ú†ÛŒØ±ÙˆÚ©", "Ø¨ÙˆÚ©", "Ú•Û•Ù†Ú¯", "Ø¯Û•Ù†Ú¯", "Ø¨Û†Ù†", "ØªØ§Ù…", "Ø²Ø§ÙˆØ§",
        "ØªØ§Ø±ÛŒÚ©", "Ú¯Ø§Ø²", "Ù¾Û•ØªÚ•Û†Úµ", "Ú©Ø§Ø±Û•Ø¨Ø§", "Ù…Û•ØªØ±Ø³ÛŒ", "Ø¦Ø§Ø³Ø§ÛŒØ´", "Ø¯Ø§Ø¯Ú¯Ø§", "ÛŒØ§Ø³Ø§", "Ø³ÛŒØ§Ø³Û•Øª", "Ø®Û•Ø³Ùˆ", 
        "Ø®Û•Ø²ÙˆØ±", "Ù…ÛÚ˜ÙˆÙˆ", "Ø¬ÙˆÚ¯Ø±Ø§ÙÛŒØ§", "ÙÛŒØ²ÛŒÚ©", "Ú©ÛŒÙ…ÛŒØ§", "Ø¨ÛŒØ±Ú©Ø§Ø±ÛŒ", "Ù¾Û•Ø±ÙˆÛ•Ø±Ø¯Û•", "Ù…Ù†Ø¯Ø§Ù„", "Ù¾ÛŒØ±",
        "Ù…Ø±Û†Ú¤", "Ù‡Û•Ù†Ø¬ÛŒØ±", "Ù¾Ø±ØªÛ•Ù‚Ø§Ù„", "Ø³ÛÙˆ", "Ø¨Ø§Ù…ÛŒÛ•", "Ø®Û†Ø´Û•ÙˆÛŒØ³Øª", "Ø¯ÙˆÚ˜Ù…Ù†", "Ú¯Ù„ÛØ´", "Ú†Û•Ù‚Ùˆ", "Ø²ÛØ±", 
        "Ø¨Ù„Ø¨Ù„", "Ø¦Ø§Ø±Ø¯", "Ù…Û•Ø³Ø§Ø³Û•", "Ø®ÙˆÛ", "Ù¾Û•ØªØ§ØªÛ•", "Ù…ÙˆÙ…", "Ø®ÙˆÛÙ†", "Ù…ÛØ´Ú©", "Ø¯Úµ", "Ú¯Û•Ø¯Û•", "Ú†Ø§Ùˆ", "Ú¯ÙˆÛ", "Ø¯Û•Ø³Øª", 
        "Ù‚Ø§Ú†", "Ù¾ÛØ³Øª", "Ù…ÙˆÙˆ", "Ù¾ÛÙ„Ø§Ùˆ", "Ù†Û•Ø¹Ø§Ù„", "Ù…Ø§ØªÛ†Ø±", "Ù‚Û•Ù„Ø§Ø¨Ù‡", "ÙÛŒØ´Û•Ú©", "Ø¨Û†Ù…Ø¨", "Ú•Û†Ú©ÛØª", "Ø´ÛØª", 
        "ØªÛ•Ø®ØªÛ•", "Ù‚ÙˆÙ…Ø§Ø´", "Ø¬Ø§Ù…", "Ù‚Û•Ù„Û•Ùˆ", "Ø¯Û•Ù…Ø§Ù†Ú†Û•", "Ø­ÙˆØ´ØªØ±", "Ù‡Û•ÙˆØ§Ù„", "ØªØ§ÙˆØ§Ù†", "Ú©Ù„ÛŒÙ„", "Ø³Ù†Ø¯ÙˆÙ‚",
        "Ø¨Ù†ÛŒØ´Øª", "Ù…Û•Ù„Û•ÙˆØ§Ù†Ú¯Û•", "Ù‡ÙˆØªÛÙ„", "Ø´Ù…Ø´ÛØ±", "Ø¦Ø§Ø´", "ÙÛÙ„Ø¨Ø§Ø²", "Ù…ÙˆÙ„Û•ØªÛŒ Ø´ÙˆÙÛØ±ÛŒ", "Ú©Ø§Ø¨ÛŒÙ†Û•", "Ø´ÙˆØ§Ù†", "Ú©Ø§Ø±Û•Ø¨Ø§", "Ù…Ø±Ø¯Ù†", "Ø´Ø§ÛŒ"
    ];


    let lang = 'ku';
    let playerCount = 4;
    let imposterCount = 1;
    let playerNames = [];
    let gameActive = false;
    let roles = [];
    let secretWord = '';
    let imposterHintWord = '';

    let isRoomMode = false;
    let currentRoomCode = null;
    let isRoomCreator = false;
    let isGameStartedInRoom = false;
    let isInputFocused = false; 

    let timerInterval;
    let timeLeft;


    const getWordList = () => WORDS_KU;

    const T = (key) => {
        const translations = {
            ku: {
                appName: "ÛŒØ§Ø±ÛŒ ÙÛÚµØ¨Ø§Ø²", imposter: "ÙÛÚµØ¨Ø§Ø²", civilian: "Ù‡Ø§ÙˆÚµØ§ØªÛŒ", playerCount: "Ú˜Ù…Ø§Ø±Û•ÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Ø§Ù† (3-12):", imposterCount: "Ú˜Ù…Ø§Ø±Û•ÛŒ ÙÛÚµØ¨Ø§Ø²Û•Ú©Ø§Ù† (1-2):", start: "Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ ÛŒØ§Ø±ÛŒ", playerName: "Ù†Ø§ÙˆÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†", showRole: "Ú•Û†ÚµÛŒ Ø®Û†Øª Ø¨Ø¨ÛŒÙ†Û•", yourRole: "Ú•Û†ÚµÛŒ ØªÛ†:", theWord: "ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ:", madeBy: "Made By Naseh M. Zebari", turn: "Ù†Û†Ø±Û•ÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Ø§Ù†", close: "Ø¯Ø§Ø®Ø³ØªÙ†", reset: "Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•", wordWas: "ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ø±ÛŒØªÛŒ Ø¨ÙˆÙˆ Ù„Û•:", selectWord: "ØªÚ©Ø§ÛŒÛ• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•!", validationTitle: "Ù‡Û†Ø´Ø¯Ø§Ø±ÛŒ", nameRequired: "ØªÚ©Ø§ÛŒÛ• Ù†Ø§ÙˆÛŒ Ù‡Û•Ù…ÙˆÙˆ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û•Ú©Ø§Ù† Ø¨Ù†ÙˆÙˆØ³Û•.", notEnoughPlayers: "Ú˜Ù…Ø§Ø±Û•ÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Ø§Ù† Ú©Û•Ù…Û•. Ù¾ÛÙˆÛŒØ³ØªØª Ø¨Û• Ù„Ø§Ù†ÛŒ Ú©Û•Ù… 3 ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û•.", impostersWere: "ÙÛÚµØ¨Ø§Ø²Û•Ú©Ø§Ù† Ø¨Ø±ÛŒØªÛŒ Ø¨ÙˆÙˆÙ† Ù„Û•:", justImposter: "ØªÛ† ÙÛÚµØ¨Ø§Ø²ÛŒ!", imposterHintLabel: "ÙˆØ´Û•:", startDiscussion: "Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ú¯ÙØªÙˆÚ¯Û†", discussionTime: "Ú©Ø§ØªÛŒ Ú¯ÙØªÙˆÚ¯Û†:", timesUp: "Ú©Ø§Øª Ú©Û†ØªØ§ÛŒÛŒ Ù‡Ø§Øª!", imposterWas: "ÙÛÚµØ¨Ø§Ø²Û•Ú©Û• Ø¨Ø±ÛŒØªÛŒ Ø¨ÙˆÙˆ Ù„Û•:", shareLink: "Ù„ÛŒÙ†Ú©ÛŒ ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Û• Ø¨Ù†ÛØ±Û• Ø¨Û† Ù‡Ø§ÙˆÚ•ÛÚ©Ø§Ù†Øª!", and: "Ùˆ", howToPlayTitle: "Ú†Û†Ù† ÛŒØ§Ø±ÛŒ Ø¯Û•Ú©Û•ÛŒØª: ÛŒØ§Ø±ÛŒ ÙÛÚµØ¨Ø§Ø²", howToPlayBody: `Ø¦Ø§Ù…Ø§Ù†Ø¬ Ø¦Û•ÙˆÛ•ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆØ§Ù† Ù‚Û•Ù†Ø§Ø¹Û•Øª Ù¾ÛØ¨Ú©Û•ÛŒØª Ú©Û• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¯Û•Ø²Ø§Ù†ÛŒØªâ€”ÛŒØ§Ø®ÙˆØ¯ Ø¦Û•Ùˆ Ú©Û•Ø³Û• Ø¨Ø¯Û†Ø²ÛŒØªÛ•ÙˆÛ• Ú©Û• Ù†Ø§ÛŒØ²Ø§Ù†ÛØª.<br><br><strong>Ù¡. ğŸ¤« Ú•Û†ÚµÛŒ Ø®Û†Øª Ø¨Ø¯Û†Ø²Û•Ø±Û•ÙˆÛ•</strong><br>â€¢ Ù…Û†Ø¨Ø§ÛŒÙ„Û•Ú©Û• Ø¨Û•Ø¯Û•ÙˆØ±Ø¯Ø§ Ø¯Û•Ø³ÙˆÚ•ÛÙ†Ø±ÛØªÛ•ÙˆÛ• Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆØ§Ù† Ø¨Û• Ù†Ù‡ÛÙ†ÛŒ Ø³Û•ÛŒØ±ÛŒ Ø´Ø§Ø´Û•Ú©Û• Ø¨Ú©Û•Ù†.<br>â€¢ Ø²Û†Ø±Ø¨Û•ÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û•Ú©Ø§Ù† <strong>ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ</strong> Ø¯Û•Ø¨ÛŒÙ†Ù† (Ø¨Û† Ù†Ù…ÙˆÙˆÙ†Û•: Ù‚Û•Ù†Û•ÙÛ•).<br>â€¢ ÛŒÛ•Ú© ÛŒØ§Ø±ÛŒØ²Ø§Ù† <strong>"ÙØ±ÛŒÙˆØ¯Û•Ø±"</strong> Ø¯Û•Ø¨ÛŒÙ†ÛØª.<br><br><strong>Ù¢. ğŸ—£ï¸ Ø¦Ø§Ù…Ø§Ú˜Û• Ø¨Ø¯Û•</strong><br>â€¢ Ø¨Û• Ø¯Û•ÙˆØ±ÛŒ Ø¨Ø§Ø²Ù†Û•Ú©Û•Ø¯Ø§ Ø¨Ú¯Û•Ú•ÛÙ†. Ù‡Û•Ø± ÛŒØ§Ø±ÛŒØ²Ø§Ù†ÛÚ© <strong>ÛŒÛ•Ú© ÙˆØ´Û•</strong> Ø¨Û† ÙˆÛ•Ø³ÙÚ©Ø±Ø¯Ù†ÛŒ ÙˆØ´Û• Ù†Ù‡ÛÙ†ÛŒÛŒÛ•Ú©Û• Ø¯Û•Ø¯Ø§Øª.<br>â€¢ <strong>Ø¦Û•Ú¯Û•Ø± ÙˆØ´Û•Ú©Û• Ø¯Û•Ø²Ø§Ù†ÛŒØª:</strong> Ø¦Ø§Ù…Ø§Ú˜Û•Ú©Û•Øª Ø¯Û•Ø¨ÛØª Ø¦Û•ÙˆÛ•Ù†Ø¯Û• Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ Ø¨ÛØª Ú©Û• Ø¨ÛŒØ³Û•Ù„Ù…ÛÙ†ÛØª Ø¯Û•ÛŒØ²Ø§Ù†ÛŒØªØŒ Ø¨Û•ÚµØ§Ù… Ø¦Û•ÙˆÛ•Ù†Ø¯Û•Ø´ Ù†Ø§Ú•ÙˆÙˆÙ† Ø¨ÛØª Ú©Û• ÙÛÚµØ¨Ø§Ø²Û•Ú©Û• Ø³Û•Ø±Ù„ÛØ´ÛÙˆØ§Ùˆ Ø¨Ú©Ø§Øª.<br>â€¢ <strong>Ø¦Û•Ú¯Û•Ø± ØªÛ† ÙÛÚµØ¨Ø§Ø²ÛŒØª:</strong> Ø¦Ø§Ù…Ø§Ú˜Û•ÛŒÛ•Ú©ÛŒ Ú¯Ø´ØªÛŒ Ø¨Ø¯Û• Ú©Û• Ù„Û•Ú¯Û•Úµ Ù¾Û†Ù„Û•Ú©Û•Ø¯Ø§ Ø¨Ú¯ÙˆÙ†Ø¬ÛØª (Ø¨Û† Ù†Ù…ÙˆÙˆÙ†Û•: Ú©Û•Ù„ÙˆÙ¾Û•Ù„) Ùˆ Ù‡Û•ÙˆÚµØ¨Ø¯Û• ØªÛÚ©Û•Úµ Ø¨Ø¨ÛŒØª!<br><br><strong>Ù£. ğŸ—³ï¸ Ø¯Û•Ù†Ú¯Ø¯Ø§Ù†</strong><br>â€¢ Ø¯ÙˆØ§ÛŒ Ù¢-Ù£ Ú¯Û•Ú•ÛŒ Ø¦Ø§Ù…Ø§Ú˜Û•Ø¯Ø§Ù†ØŒ Ú¯ÙØªÙˆÚ¯Û† Ø¯Û•Ø³ØªÙ¾ÛØ¯Û•Ú©Ø§Øª. ØªÛ†Ù…Û•Øª Ø¨Ø®Û•Ø±Û• Ù¾Ø§Úµ Ø¦Û•Ùˆ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û•ÛŒ Ú©Û• Ø¦Ø§Ù…Ø§Ú˜Û•Ú©Ø§Ù†ÛŒ Ú¯ÙˆÙ…Ø§Ù†Ø§ÙˆÛŒØªØ±ÛŒÙ† ÛŒØ§Ù† Ú¯Ø´ØªÛŒØªØ±ÛŒÙ† Ø¨ÙˆÙˆÙ†.<br>â€¢ Ù‡Û•Ù…ÙˆÙˆØ§Ù† Ø¯Û•Ù†Ú¯ Ø¯Û•Ø¯Û•Ù† Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø¨Ø²Ø§Ù†Ù† Ú©Û Ú¯ÙˆÙ…Ø§Ù†Ø§ÙˆÛŒÛŒÛ•. Ø¦Û•Ùˆ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û•ÛŒ Ø²Û†Ø±ØªØ±ÛŒÙ† Ø¯Û•Ù†Ú¯ Ø¨Û•Ø¯Û•Ø³Øª Ø¯Û•Ù‡ÛÙ†ÛØª Ø¦Ø§Ø´Ú©Ø±Ø§ Ø¯Û•Ú©Ø±ÛØª.<br><br><strong>Ú†Û†Ù† Ø¯Û•ÛŒØ¨Û•ÛŒØªÛ•ÙˆÛ• ğŸ† :</strong><br><br>â€¢ <strong>Ù‡Ø§ÙˆÚµØ§ØªÛŒÛŒÛ•Ú©Ø§Ù†:</strong><br>-Ø¦Û•Ú¯Û•Ø± Ù¾ÛØ´ Ú©Û†ØªØ§ÛŒÛŒ Ù‡Ø§ØªÙ†ÛŒ Ú©Ø§Øª ÙÛÙ„Ø¨Ø§Ø²Û•Ú©Û• Ø¨Ø¯Û†Ø²Ù†Û•ÙˆÛ•.<br><br>â€¢ <strong>ÙÛÚµØ¨Ø§Ø²:</strong><br>-Ø¦Û•Ú¯Û•Ø± Ù‡Ø§ÙˆÚµØ§ØªÛŒÛŒÛ•Ú©Ø§Ù† Ù†Û•ÛŒØ§Ù†Ø¯Û†Ø²Ù†Û•ÙˆÛ• Ú©Û• Ú©Û ÙÛÚµØ¨Ø§Ø²Û•.<br>-Ø¦Û•Ú¯Û•Ø± Ú©Ø§ØªÛ•Ú©Û• Ú©Û†ØªØ§ÛŒÛŒ Ø¨ÛØª.`,
                room: "Ú˜ÙˆÙˆØ±", playWithFriends: "ÛŒØ§Ø±ÛŒ Ù„Û•Ú¯Û•Úµ Ù‡Ø§ÙˆÚ•ÛÛŒØ§Ù†", createRoom: "Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ú˜ÙˆÙˆØ±", joinRoom: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•", roomCode: "Ú©Û†Ø¯ÛŒ Ú˜ÙˆÙˆØ±:", enterCode: "Ú©Û†Ø¯ÛŒ Ú˜ÙˆÙˆØ± Ø¨Ù†ÙˆÙˆØ³Û•", creator: "Ø¯Ø±ÙˆØ³ØªÚ©Û•Ø±", myStatus: "Ø¯Û†Ø®ÛŒ Ù…Ù†:", waitingForName: "Ú†Ø§ÙˆÛ•Ú•ÛÛŒ Ù†ÙˆÙˆØ³ÛŒÙ†ÛŒ Ù†Ø§Ùˆ", waitingForOthers: "Ú†Ø§ÙˆÛ•Ú•ÛÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Ø§Ù†ÛŒ ØªØ±", ready: "Ø¦Ø§Ù…Ø§Ø¯Û•", submit: "Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ø¯Ù†Û•ÙˆÛ•", notEnoughPlayersPopup: "Ú˜Ù…Ø§Ø±Û•ÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†Ø§Ù† Ú©Û•Ù…Û•. Ù„Ø§Ù†ÛŒ Ú©Û•Ù… 3 ÛŒØ§Ø±ÛŒØ²Ø§Ù† Ù¾ÛÙˆÛŒØ³ØªÛ•.", roomFull: "Ú˜ÙˆÙˆØ±Û•Ú©Û• Ù¾Ú•Û•.", roomNotFound: "Ú©Û†Ø¯ÛŒ Ú˜ÙˆÙˆØ±Û•Ú©Û• Ù†Ø§Ø¯Ø±ÙˆØ³ØªÛ•.", roomStart: "Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ ÛŒØ§Ø±ÛŒ (3+ ÛŒØ§Ø±ÛŒØ²Ø§Ù†)", gameAlreadyStarted: "ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Û• Ø¯Û•Ø³ØªÛŒÙ¾ÛÚ©Ø±Ø¯ÙˆÙˆÛ•...", enterYourName: "Ù†Ø§ÙˆÛŒ Ø®Û†Øª Ø¨Ù†ÙˆÙˆØ³Û•", nameSubmitSuccess: "Ù†Ø§ÙˆÛŒ ØªÛ† Ù†ÙˆÙˆØ³Ø±Ø§. Ú†Ø§ÙˆÛ•Ú•ÛÛŒ Ø¦Û•ÙˆØ§Ù†ÛŒ ØªØ± Ø¨Û•.", gameOverTitle: "Ú©Û†ØªØ§ÛŒÛŒ ÛŒØ§Ø±ÛŒ", playAgain: "Ø¯ÙˆÙˆØ¨Ø§Ø±Û• ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•ÙˆÛ• Ù„Û• Ù‡Û•Ù…Ø§Ù† Ú˜ÙˆÙˆØ±", exitRoom: "Ú†ÙˆÙˆÙ†Û• Ø¯Û•Ø±Û•ÙˆÛ•ÛŒ Ú˜ÙˆÙˆØ±", startOver: "Ø¯Û•Ø³ØªÙ¾ÛÚ©ÛŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• (ÙˆØ´Û• Ùˆ Ú•Û†ÚµÛŒ Ù†ÙˆÛ)", backToSetup: "Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†",
                finishTheTimer: "Ú©Û†ØªØ§ÛŒÛŒ Ù‡ÛÙ†Ø§Ù† Ø¨Û• Ú©Ø§Øª", remove: "Ù„Ø§Ø¨Ø±Ø¯Ù†" // Added translation for 'remove'
            }
        };
        return translations.ku[key] || key;
    };
    
    const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    };

    const showModal = (titleKey, messageKey, isImposterReveal = false, customContent = null, closeCallback = hideModal) => {
        const title = T(titleKey);
        let message = T(messageKey);
        
        if(isImposterReveal) {
             message = messageKey;
        }
        
        modalInner.className = 'modal-content ' + (isImposterReveal ? 'imposter-popup' : '');
        modalInner.innerHTML = `
            <button class="modal-close-btn" onclick="${closeCallback.name}()">Ã—</button>
            <h3 class="modal-title">${title}</h3>
            <div class="modal-message">
                ${customContent || message}
            </div>
            ${!isImposterReveal ? `<button class="primary-btn" onclick="${closeCallback.name}()">
                ${T('close')}
            </button>` : `<button class="primary-btn mt-4" onclick="${closeCallback.name}()">
                ${T('close')}
            </button>`}
        `;
        modal.classList.add('show');
    };

    const hideModal = () => {
        modal.classList.remove('show');
    };

    const shareGameLink = async () => {
        if (!currentRoomCode && isRoomMode) return;
        
        let url = window.location.href.split('?')[0];
        let shareText = T('shareLink');
        
        if (isRoomMode) {
           url = url + `?room=${currentRoomCode}`;
           shareText = `${T('roomCode')} ${currentRoomCode}. ${T('shareLink')}`;
        }
        
        if (navigator.share) {
            try {
                await navigator.share({
                    title: T('appName'),
                    text: shareText,
                    url: url
                });
            } catch (error) {
                await navigator.clipboard.writeText(url);
                showModal('roomCode', `${isRoomMode ? currentRoomCode : url}<br><br><strong>${T('shareLink')}</strong>`);
            }
        } else {
            await navigator.clipboard.writeText(url);
            showModal('roomCode', `${isRoomMode ? currentRoomCode : url}<br><br><strong>${T('shareLink')}</strong>`);
        }
    };

    const showHelpModal = () => {
        showModal('howToPlayTitle', 'howToPlayBody', false, T('howToPlayBody'));
    };

    const getRoomSnapshot = async (code) => {
        try {
            const snapshot = await database.ref('rooms/' + code).once('value');
            return snapshot.val();
        } catch (error) {
            console.error("Error getting room snapshot:", error);
            return null;
        }
    };

    const startRoomPolling = () => {
        if (!currentRoomCode) return;
        
        if (roomRef) roomRef.off('value', pollRoomCallback);

        roomRef = database.ref('rooms/' + currentRoomCode);
        
        roomRef.on('value', pollRoomCallback, (error) => {
            console.error("Firebase listener error:", error);
            if (currentRoomCode) {
                showModal('validationTitle', 'roomNotFound', false, null, resetGame);
            }
        });
    };

    const stopRoomPolling = () => {
        if (roomRef) {
            roomRef.off('value', pollRoomCallback);
            roomRef = null;
        }
    };
    
    const pollRoomCallback = (snapshot) => {
        const room = snapshot.val();
        
        if (!room) {
            stopRoomPolling();
            if (currentRoomCode) {
                showModal('validationTitle', 'roomNotFound', false, null, resetGame);
            }
            return;
        }
        
        if (isInputFocused) {
           return;
        }

        if (myPlayerId && !room.players.some(p => p.id === myPlayerId)) {
            stopRoomPolling();
            resetGame();
            return;
        }
        
        isRoomCreator = room.creatorId === myPlayerId; // Update creator status on poll
        imposterCount = room.imposterCount;
        playerCount = room.players.length;
        
        const myPlayerData = room.players.find(p => p.id === myPlayerId);
        if (myPlayerData) {
             roles = room.players;
             secretWord = room.secretWord;
             imposterHintWord = room.imposterHintWord;
        }


        if (room.gameState === 'playing' && !isGameStartedInRoom) {
            isGameStartedInRoom = true;
            startGame(room);
        } else if (room.gameState === 'ended' && isGameStartedInRoom) {
            renderGameOverModal();
        } else if (room.gameState === 'setup') {
            if (!isGameStartedInRoom) {
               renderRoomLobby(room);
            } else {
                 isGameStartedInRoom = false;
                 roles = [];
                 clearInterval(timerInterval);
                 timerInterval = null;
                 timeLeft = null;
                 renderRoomLobby(room);
            }
        } else if (room.gameState === 'playing' && isGameStartedInRoom) {
            renderEndGameView(true);
        }
    };

    const generateRoomCode = () => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let code = '';
        for (let i = 0; i < 4; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    };

    const createRoom = async () => {
        let code = generateRoomCode();
        let existingRoom = await getRoomSnapshot(code);
        while (existingRoom) {
            code = generateRoomCode();
            existingRoom = await getRoomSnapshot(code);
        }
        
        myPlayerId = database.ref().push().key; 
        
        const newRoom = {
            code: code,
            creatorId: myPlayerId,
            imposterCount: 1,
            players: [
                { id: myPlayerId, name: '', isReady: false, role: '', word: '' }
            ],
            gameState: 'setup',
            secretWord: '',
            imposterHintWord: '',
            discussionStartTime: null,
            discussionDuration: 0
        };
        
        roomRef = database.ref('rooms/' + code);
        await roomRef.set(newRoom);
        
        currentRoomCode = code;
        isRoomCreator = true;
        isRoomMode = true;
        
        renderRoomLobby(newRoom);
        startRoomPolling();
    };

    const joinRoom = async (code) => {
        code = code.toUpperCase();
        const room = await getRoomSnapshot(code);
        
        if (!room) {
            showModal('validationTitle', 'roomNotFound');
            return;
        }
        if (room.players.length >= 12) {
            showModal('validationTitle', 'roomFull');
            return;
        }
        if (room.gameState !== 'setup') {
            showModal('validationTitle', 'gameAlreadyStarted');
            return;
        }
        
        myPlayerId = database.ref().push().key; 
        const newPlayer = { id: myPlayerId, name: '', isReady: false, role: '', word: '' };
        
        roomRef = database.ref('rooms/' + code);
        room.players.push(newPlayer);
        await roomRef.update({ players: room.players });
        
        currentRoomCode = code;
        isRoomCreator = room.creatorId === myPlayerId;
        isRoomMode = true;
        
        renderRoomLobby(room);
        startRoomPolling();
    };

    const submitName = async () => {
        const nameInput = document.getElementById('my-name-input');
        const myName = nameInput.value.trim();
        
        if (myName.length < 1) {
            showModal('validationTitle', 'nameRequired');
            return;
        }
        
        isInputFocused = true;
        const room = await getRoomSnapshot(currentRoomCode);
        isInputFocused = false;
        if (!room) return;

        const myPlayerIndex = room.players.findIndex(p => p.id === myPlayerId);
        if (myPlayerIndex !== -1) {
            room.players[myPlayerIndex].name = myName;
            room.players[myPlayerIndex].isReady = true;
            
            await roomRef.update({ players: room.players });
            
            showModal('validationTitle', 'nameSubmitSuccess', false, null, hideModal);
        }
    };
    
    const updateRoomSettings = async (imposterValue) => {
        if (!isRoomCreator) return;
        
        let count = parseInt(imposterValue);
        const room = await getRoomSnapshot(currentRoomCode);
        
        if (!room) return;

        if (isNaN(count) || count < 1) count = 1;
        if (count > 2) count = 2;
        if (count >= room.players.length && room.players.length > 1) {
            count = room.players.length - 1;
        }
        if (count < 1 && room.players.length > 0) count = 1;

        if (roomRef) {
            await roomRef.update({ imposterCount: count });
            imposterCount = count;
        }
    };

    // New function to remove a player
    const removePlayerFromRoom = async (playerIdToRemove) => {
        if (!isRoomCreator || playerIdToRemove === myPlayerId) return; 

        isInputFocused = true;
        const room = await getRoomSnapshot(currentRoomCode);
        isInputFocused = false;
        if (!room) return;

        const updatedPlayers = room.players.filter(p => p.id !== playerIdToRemove);

        if (updatedPlayers.length === 0) {
            await database.ref('rooms/' + currentRoomCode).remove();
        } else {
            let updates = { players: updatedPlayers };
            // If the removed player was the creator, assign new creator (the first player in the list)
            if (room.creatorId === playerIdToRemove) {
                 updates.creatorId = updatedPlayers[0].id;
            }
            await database.ref('rooms/' + currentRoomCode).update(updates);
        }
    };


    const startRoomGame = async () => {
        const room = await getRoomSnapshot(currentRoomCode);
        if (!room || room.players.length < 3) {
            renderNotEnoughPlayersModal();
            return;
        }
        
        const readyPlayers = room.players.filter(p => p.isReady && p.name);
        if (readyPlayers.length < room.players.length) {
            showModal('validationTitle', 'nameRequired');
            return;
        }
        
        const wordList = getWordList();
        const secretIndex = Math.floor(Math.random() * wordList.length);
        const newSecretWord = wordList[secretIndex];
        const newImposterHintWord = T('justImposter');
        
        const imposterIndices = [];
        while (imposterIndices.length < room.imposterCount) {
            const index = Math.floor(Math.random() * readyPlayers.length);
            if (!imposterIndices.includes(index)) {
                imposterIndices.push(index);
            }
        }
        
        let rolesList = readyPlayers.map((p, i) => {
            const isImposter = imposterIndices.includes(i);
            const role = isImposter ? T('imposter') : T('civilian');
            const wordContent = isImposter ? newImposterHintWord : newSecretWord;
            
            return {
                ...p,
                role: role,
                word: wordContent,
                name: p.name.trim(),
            };
        });

        rolesList = rolesList.sort(() => Math.random() - 0.5);
        
        room.players = rolesList;
        room.secretWord = newSecretWord;
        room.imposterHintWord = newImposterHintWord;
        room.gameState = 'playing';
        
        roles = rolesList;

        await roomRef.update({
            players: room.players,
            secretWord: room.secretWord,
            imposterHintWord: room.imposterHintWord,
            gameState: room.gameState
        });

        isGameStartedInRoom = true;
        startGame(room);
    };

    const resetRoomGame = async () => {
        const room = await getRoomSnapshot(currentRoomCode);
        if (!room) return;
        
        const updates = {
            gameState: 'setup',
            secretWord: '',
            imposterHintWord: '',
            discussionStartTime: null,
            discussionDuration: 0,
            players: room.players.map(p => ({ ...p, isReady: false, role: '', word: '' }))
        };
        
        await roomRef.update(updates);
        
        isGameStartedInRoom = false;
        roles = [];
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = null;
        
        hideModal();
    };

    const finishRoomTimer = async () => {
        if (!isRoomMode || !isRoomCreator) return;
        
        if (roomRef) {
            clearInterval(timerInterval);
            timerInterval = null;
            timeLeft = 0;
            await roomRef.update({ gameState: 'ended' });
            renderGameOverModal();
        }
    };
    
    const finishLocalTimer = () => {
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = 0;
        
        // --- Ù†ÙˆÛÚ©Ø±Ø§ÙˆÛ• Ø¨Û† Ø¯Û†Ø®ÛŒ Ø¦Ø§Ø³Ø§ÛŒÛŒ ---
        document.getElementById('timerDisplay').textContent = T('timesUp');
        
        const imposterNames = roles
            .filter(r => r.role === T('imposter'))
            .map(r => r.name);
        const imposterList = imposterNames.join(' ' + T('and') + ' ');
        
        const message = `
            <div class="text-right">
                <p class="text-lg text-slate-300 mb-2">${T('wordWas')}</p>
                <p class="text-2xl font-bold text-primary mb-4">${secretWord}</p>
                <p class="text-lg text-slate-300 mb-2">${T('impostersWere')}</p>
                <p class="text-2xl font-bold word-imposter">${imposterList}</p>
            </div>
        `;
        showModal('gameOverTitle', '', true, message);
    }

    const timerFinished = async () => {
        clearInterval(timerInterval);
        timerInterval = null;
        
        if(isRoomMode) {
            if(isRoomCreator) {
                await roomRef.update({ gameState: 'ended' });
                renderGameOverModal();
            }
        } else {
            finishLocalTimer();
        }
    }

    const countdown = () => {
        if (timeLeft <= 0) {
            timerFinished();
        } else {
            timeLeft--;
            const timerEl = document.getElementById('timerDisplay');
            if(timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
        }
    }
    
    const startDiscussion = async () => {
        if (timerInterval) return;

        const duration = playerCount * 60;

        if (isRoomMode) {
            if (isRoomCreator) {
                const room = await getRoomSnapshot(currentRoomCode);
                if (room && room.gameState === 'playing') {
                    
                    await roomRef.update({
                        discussionStartTime: firebase.database.ServerValue.TIMESTAMP,
                        discussionDuration: duration
                    });
                    
                    timeLeft = duration;
                    timerInterval = setInterval(countdown, 1000); 
                    
                    const startButton = document.getElementById('startDiscussionButton');
                    if(startButton) {
                       startButton.textContent = T('discussionTime');
                       startButton.disabled = true;
                    }
                    const timerEl = document.getElementById('timerDisplay');
                    if(timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
                    
                    const endBtn = document.getElementById('finishLocalTimerButton');
                    if(endBtn) endBtn.classList.remove('hidden');
                }
            }
        } else {
            timeLeft = duration; 
            const startButton = document.getElementById('startDiscussionButton');
            startButton.textContent = T('discussionTime');
            startButton.disabled = true;
            document.getElementById('timerDisplay').textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
            timerInterval = setInterval(countdown, 1000); 
            
            // --- Ù†ÙˆÛÚ©Ø±Ø§ÙˆÛ• Ø¨Û† Ø¯Û†Ø®ÛŒ Ø¦Ø§Ø³Ø§ÛŒÛŒ ---
            const endBtn = document.getElementById('finishLocalTimerButton');
            if(endBtn) endBtn.classList.remove('hidden');
        }
    };
    
    const renderEndGameView = (isRoom = false) => {
        const container = document.getElementById('game-container');
        
        const initialTime = playerCount * 60;
        const initialTimeFormatted = formatTime(initialTime);
        let displayTime = timerInterval ? `${T('discussionTime')} ${formatTime(timeLeft)}` : `${T('discussionTime')} ${initialTimeFormatted}`;
        
        
        if (isRoom && roomRef && !isRoomCreator) {
            roomRef.once('value').then(snapshot => {
                const room = snapshot.val();
                const timerEl = document.getElementById('timerDisplay');
                
                if(room && room.discussionStartTime && room.discussionDuration) {
                    const elapsed = Date.now() - room.discussionStartTime;
                    const remaining = room.discussionDuration * 1000 - elapsed;
                    
                    if(remaining > 0) {
                        timeLeft = Math.ceil(remaining / 1000);
                        if (timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
                        if (!timerInterval) {
                             timerInterval = setInterval(countdown, 1000); 
                        }
                    } else {
                         if (timerEl) timerEl.textContent = T('timesUp');
                    }
                } else {
                     if (timerEl) timerEl.textContent = T('waitingForOthers');
                }
            });
            displayTime = T('waitingForOthers');
        }
        
        if (isRoom && !isRoomCreator) {
            const roomData = roles.find(p => p.id === myPlayerId);
             if (roomData && roomData.role) {
                secretWord = roles.find(p => p.role === T('civilian'))?.word || '';
                imposterHintWord = T('justImposter');
                
                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                    <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')}</h2>
                    <div class="title-bar mb-6"></div>
                    
                    <div class="player-card">
                        <p class="text-lg text-slate-300 mb-2">${roomData.name}</p>
                        <p class="role-text-simplified ${roomData.role === T('imposter') ? 'word-imposter' : 'word-civilian'}">
                           ${roomData.role === T('imposter') ? T('justImposter') : roomData.word}
                        </p>
                    </div>

                    <p id="timerDisplay" class="text-2xl text-slate-200 text-center mt-6 mb-4">${displayTime}</p>
                    <button id="startDiscussionButton" class="primary-btn mb-6 opacity-50 cursor-not-allowed" 
                            disabled style="background: linear-gradient(145deg, #6366f1, #4f46e5); color: white;">
                        ${T('startDiscussion')}
                    </button>
                    <p class="text-sm text-center text-slate-400">${T('waitingForOthers')}</p>
                    
                    <div class="mt-8">
                        <button class="back-btn mt-2" onclick="exitRoom()">
                            ${T('exitRoom')}
                        </button>
                    </div>
                    <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
                `;
                return;
            }
        }
        
        container.innerHTML = `
             <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
             <h2 id="timerDisplay" class="text-2xl text-slate-200 text-center mb-6">${displayTime}</h2>
             <div class="title-bar mb-6"></div>

             <button id="startDiscussionButton" class="primary-btn mb-6 ${isRoom && !isRoomCreator ? 'opacity-50 cursor-not-allowed' : ''}" 
                     onclick="startDiscussion()" 
                     ${isRoom && !isRoomCreator ? 'disabled' : ''}
                     style="background: linear-gradient(145deg, #6366f1, #4f46e5); color: white;">
                 ${T('startDiscussion')}
             </button>

             ${isRoom && isRoomCreator ? `
                 <button class="primary-btn secondary-btn mb-4" onclick="finishRoomTimer()" style="background: linear-gradient(145deg, #f87171, #ef4444); color: white;">
                     ${T('finishTheTimer')}
                 </button>
             ` : !isRoom ? `
                 <button id="finishLocalTimerButton" class="primary-btn secondary-btn mb-4 hidden" onclick="finishLocalTimer()" style="background: linear-gradient(145deg, #f87171, #ef4444); color: white;">
                     ${T('finishTheTimer')}
                 </button>
             ` : ''}

             <div class="mt-8">
                 ${isRoom ? `
                    <button class="primary-btn bg-secondary hover:bg-indigo-600 mb-4" onclick="resetRoomGame()" ${!isRoomCreator ? 'disabled' : ''} style="background: linear-gradient(145deg, #facc15, #eab308); color: #1e293b;">
                         ${T('startOver')}
                     </button>
                    <button class="back-btn mt-2" onclick="exitRoom()">
                        ${T('exitRoom')}
                    </button>
                 ` : `
                    <button class="primary-btn bg-secondary hover:bg-indigo-600" onclick="resetGame()" style="background: linear-gradient(145deg, #facc15, #eab308); color: #1e293b;">
                         ${T('reset')}
                     </button>
                 `}
             </div>
           
             <div class="footer-text mt-8">
                 ${T('madeBy')}
                 <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
             </div>
         `;
         
         if(timerInterval) {
             const startButton = document.getElementById('startDiscussionButton');
             if(startButton) {
                 startButton.textContent = T('discussionTime');
                 startButton.disabled = true;
             }
             const endBtn = document.getElementById('finishLocalTimerButton');
             if(endBtn && !isRoom) endBtn.classList.remove('hidden');
         }
    };
    
    const getNamesFromDOM = () => {
         const inputs = document.querySelectorAll('#player-names-input input[type="text"]');
         playerNames = Array.from(inputs).map(input => input.value.trim());
         return playerNames;
    };
    
    const startGame = (roomData = null) => {
        hideModal();
        gameActive = true;
        
        if (roomData) {
            isRoomMode = true;
            roles = roomData.players;
            playerCount = roles.length;
            imposterCount = roomData.imposterCount;
            secretWord = roomData.secretWord;
            imposterHintWord = roomData.imposterHintWord;
            
            const myPlayerIndex = roles.findIndex(p => p.id === myPlayerId);
            renderRoomGameView(myPlayerIndex);
            
        } else {
            playerNames = getNamesFromDOM().filter(n => n.length > 0);
            playerCount = playerNames.length;
            
            if (playerCount < 3) {
                 renderNotEnoughPlayersModal();
                 gameActive = false;
                 return;
            }
            if (playerNames.some(name => name.length < 1)) {
                 showModal('validationTitle', 'nameRequired');
                 gameActive = false;
                 return;
            }

            const wordList = getWordList();
            const secretIndex = Math.floor(Math.random() * wordList.length);
            secretWord = wordList[secretIndex];
            imposterHintWord = T('justImposter');
            
            const imposterIndices = [];
            while (imposterIndices.length < imposterCount) {
                const index = Math.floor(Math.random() * playerCount);
                if (!imposterIndices.includes(index)) {
                    imposterIndices.push(index);
                }
            }
            
            roles = playerNames.map((name, i) => {
                const isImposter = imposterIndices.includes(i);
                return {
                    name: name,
                    role: isImposter ? T('imposter') : T('civilian'),
                    word: isImposter ? imposterHintWord : secretWord
                };
            }).sort(() => Math.random() - 0.5);

            renderPlayerTurnView(0);
        }
    };

    const showRole = (playerIndex) => {
        const roleData = isRoomMode ? roles.find(p => p.id === myPlayerId) : roles[playerIndex];
        
        if (!roleData) return;
        
        const isImposter = roleData.role === T('imposter');
        const roleContent = isImposter 
            ? `<p class="role-text-simplified word-imposter">${T('justImposter')}</p>`
            : `<p class="role-text-simplified word-civilian">${roleData.word}</p>`;

        const container = isRoomMode ? document.getElementById('room-player-turn') : document.getElementById('player-turn-view');
        
        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('yourRole')}</h2>
            <div class="title-bar mb-6"></div>

            <div class="player-card">
                <p class="text-lg text-slate-300 mb-2">${roleData.name}</p>
                ${roleContent}
            </div>
            
            <button class="primary-btn mt-6" onclick="hideRole(${playerIndex})">
                ${T('close')}
            </button>
        `;
    };

    const hideRole = (playerIndex) => {
        if (isRoomMode) {
            renderEndGameView(true);
        } else if (playerIndex < roles.length - 1) {
            renderPlayerTurnView(playerIndex + 1);
        } else {
            renderEndGameView(false);
        }
    };
    
    const renderPlayerTurnView = (playerIndex = 0) => {
        const container = document.getElementById('game-container');
        const currentPlayer = roles[playerIndex];
        const totalPlayers = roles.length;

        container.innerHTML = `
            <div id="player-turn-view">
                <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')} ${playerIndex + 1}/${totalPlayers}</h2>
                <div class="title-bar mb-6"></div>

                <div class="player-card">
                    <p class="text-lg text-slate-300 mb-2">${T('playerName')}:</p>
                    <p class="text-3xl font-bold text-primary">${currentPlayer.name}</p>
                </div>

                <button class="primary-btn mt-6" onclick="showRole(${playerIndex})">
                    ${T('showRole')}
                </button>
                
                <button class="back-btn" onclick="resetGame()">
                    ${T('backToSetup')}
                </button>
                 <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
            </div>
        `;
    };
    
    const renderRoomGameView = (myPlayerIndex) => {
        const container = document.getElementById('game-container');
        const myPlayerData = roles.find(p => p.id === myPlayerId);
        
        if (!myPlayerData) return;

        container.innerHTML = `
            <div id="room-player-turn">
                <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')}</h2>
                <div class="title-bar mb-6"></div>

                <div class="player-card">
                    <p class="text-lg text-slate-300 mb-2">${T('playerName')}:</p>
                    <p class="text-3xl font-bold text-primary">${myPlayerData.name}</p>
                </div>

                <button class="primary-btn mt-6" onclick="showRole(${myPlayerIndex})">
                    ${T('showRole')}
                </button>
                
                <button class="back-btn" onclick="exitRoom()">
                    ${T('exitRoom')}
                </button>
                 <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
            </div>
        `;
    };
    
    const renderGameOverModal = () => {
        const imposterNames = roles
            .filter(r => r.role === T('imposter'))
            .map(r => r.name);
        const imposterList = imposterNames.join(' ' + T('and') + ' ');
        
        const message = `
            <div class="text-right">
                <p class="text-lg text-slate-300 mb-2">${T('wordWas')}</p>
                <p class="text-2xl font-bold text-primary mb-4">${secretWord}</p>
                <p class="text-lg text-slate-300 mb-2">${T('impostersWere')}</p>
                <p class="text-2xl font-bold word-imposter">${imposterList}</p>
            </div>
            <button class="primary-btn mt-6 mb-2" onclick="${isRoomCreator ? 'resetRoomGame()' : 'hideModal()'}">
                ${isRoomCreator ? T('playAgain') : T('close')}
            </button>
            <button class="back-btn mt-2" onclick="exitRoom()">
                ${T('exitRoom')}
            </button>
        `;

        showModal('gameOverTitle', '', true, message, hideModal);
    };

    const renderNotEnoughPlayersModal = () => {
        showModal('validationTitle', 'notEnoughPlayersPopup');
    };

    const renderSetupView = () => {
        isRoomMode = false;
        gameActive = false;
        helpButton.classList.remove('hidden');

        const container = document.getElementById('game-container');
        
        if (playerNames.length !== playerCount) {
             playerNames = Array(playerCount).fill('').map((_, i) => playerNames[i] || '');
        }

        const nameInputs = playerNames.map((name, index) => `
            <input type="text" placeholder="${T('playerName')} ${index + 1}" value="${name}" 
                   onfocus="isInputFocused = true" 
                   onblur="isInputFocused = false" 
                   onchange="getNamesFromDOM()">
        `).join('');

        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <p class="text-slate-300 mb-2 text-right">${T('playerCount')}</p>
            <input type="number" min="3" max="12" value="${playerCount}" onchange="handlePlayerCountChange(event)" class="mb-4">

            <p class="text-slate-300 mb-2 text-right">${T('imposterCount')}</p>
            <input type="number" min="1" max="2" value="${imposterCount}" onchange="handleImposterCountChange(event)" class="mb-6">

            <div id="player-names-input">
                <p class="text-slate-300 mb-2 text-right">${T('playerName')} ${T('and')} ${T('playerName')}:</p>
                ${nameInputs}
            </div>

            <button class="primary-btn mt-6" onclick="startGame()">
                ${T('start')}
            </button>
            
            <button class="secondary-btn" onclick="renderRoomMenu()">
                ${T('playWithFriends')}
            </button>
            
            <div class="footer-text">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const handlePlayerCountChange = (event) => {
         let count = parseInt(event.target.value);
         if (isNaN(count) || count < 3) count = 3;
         if (count > 12) count = 12;
         playerCount = count;
         if (imposterCount >= count) {
             imposterCount = count > 1 ? 1 : 1;
         }
         
         if (playerNames.length > playerCount) {
             playerNames = playerNames.slice(0, playerCount);
         } else if (playerNames.length < playerCount) {
             for (let i = playerNames.length; i < playerCount; i++) {
                 playerNames.push('');
             }
         }
         renderSetupView();
     };

     const handleImposterCountChange = (event) => {
         let count = parseInt(event.target.value);
         if (isNaN(count) || count < 1) count = 1;
         if (count > 2 || count >= playerCount) count = Math.min(2, playerCount - 1);
         imposterCount = count;
         renderSetupView();
     };

    const renderRoomMenu = () => {
        const container = document.getElementById('game-container');
        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <button class="secondary-btn mb-4" onclick="createRoom()">
                ${T('createRoom')}
            </button>
            
            <p class="text-slate-300 mb-2 text-right">${T('enterCode')}</p>
            <input type="text" id="join-code-input" placeholder="ABCD" maxlength="4" onfocus="isInputFocused = true" onblur="isInputFocused = false">
            
            <button class="primary-btn" onclick="joinRoom(document.getElementById('join-code-input').value)">
                ${T('joinRoom')}
            </button>
            
            <button class="back-btn" onclick="renderSetupView()">
                ${T('backToSetup')}
            </button>
            
            <div class="footer-text mt-8">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const copyRoomCode = async () => {
        if (currentRoomCode) {
            await navigator.clipboard.writeText(currentRoomCode);
            showModal('roomCode', `${currentRoomCode}<br><br><strong>${T('shareLink')}</strong>`);
        }
     };

    const renderRoomLobby = (room) => {
        currentRoomCode = room.code;
        isRoomCreator = room.creatorId === myPlayerId;
        
        const myPlayerData = room.players.find(p => p.id === myPlayerId) || { name: '', isReady: false };
        const myPlayerName = myPlayerData.name;
        const myStatusKey = myPlayerData.name ? (myPlayerData.isReady ? 'ready' : 'waitingForOthers') : 'waitingForName';
        
        const container = document.getElementById('game-container');
        
        shareButton.classList.remove('hidden');

        const playerListHTML = room.players.map(p => {
            const isCreator = p.id === room.creatorId;
            const isMe = p.id === myPlayerId;
            const statusText = p.isReady ? T('ready') : T('waitingForName');
            const statusClass = p.isReady ? 'ready' : '';
            
            // Add remove button for creator, but not for themselves
            const removeButton = isRoomCreator && !isMe ? 
                `<button class="remove-btn" onclick="removePlayerFromRoom('${p.id}')">${T('remove')}</button>` : 
                '';
            
            return `
                <div class="lobby-player-item ${isCreator ? 'creator' : ''}">
                    <div class="flex items-center">
                        ${removeButton}
                        <span class="font-bold">${p.name || T('waitingForName')} ${isCreator ? `(${T('creator')})` : ''}</span>
                    </div>
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
            `;
        }).join('');

        const isMinimumPlayers = room.players.length >= 3;
        const allPlayersReady = room.players.every(p => p.isReady && p.name);

        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <p id="room-code-label">${T('roomCode')}</p>
            <p id="room-code-display" onclick="copyRoomCode()">${room.code}</p>
            <p class="text-sm text-slate-400 text-center mb-6">${T('shareLink')}</p>
            
            <div class="flex justify-between items-center text-slate-300 mb-4">
                <p><strong>${T('myStatus')}</strong></p>
                <p class="status ${myStatusKey === 'ready' ? 'ready' : ''}">${T(myStatusKey)}</p>
            </div>
            
            <p class="text-slate-300 mb-2 text-right">${T('enterYourName')}</p>
            <div class="flex gap-2">
                <input type="text" id="my-name-input" placeholder="${T('playerName')}" value="${myPlayerName}" 
                       onfocus="isInputFocused = true" 
                       onblur="isInputFocused = false" 
                       class="flex-grow">
                <button class="primary-btn w-auto px-6 py-2" onclick="submitName()">
                    ${T('submit')}
                </button>
            </div>

            ${isRoomCreator ? `
                <div class="mt-4">
                    <p class="text-slate-300 mb-2 text-right">${T('imposterCount')}</p>
                    <input type="number" min="1" max="2" value="${room.imposterCount}" 
                           onchange="updateRoomSettings(this.value)" class="mb-4">
                </div>
            ` : `<p class="text-slate-400 text-sm mt-4 text-center">${T('imposterCount')}: ${room.imposterCount}</p>`}

            <div class="mt-6 mb-4 max-h-40 overflow-y-auto pr-1">
                ${playerListHTML}
            </div>

            <button class="primary-btn mt-4 ${!isMinimumPlayers || !allPlayersReady || !isRoomCreator ? 'opacity-50 cursor-not-allowed' : ''}" 
                    onclick="startRoomGame()" ${!isMinimumPlayers || !allPlayersReady || !isRoomCreator ? 'disabled' : ''}>
                ${T('roomStart')}
            </button>
            
            <button class="back-btn" onclick="exitRoom()">
                ${T('exitRoom')}
            </button>
            
            <div class="footer-text mt-8">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const exitRoom = async () => {
        if (!currentRoomCode) {
            resetGame();
            return;
        }
        
        stopRoomPolling();
        
        const room = await getRoomSnapshot(currentRoomCode);
        if (room) {
            const updatedPlayers = room.players.filter(p => p.id !== myPlayerId);
            
            if (updatedPlayers.length === 0) {
                await database.ref('rooms/' + currentRoomCode).remove();
            } else {
                let updates = { players: updatedPlayers };
                if (isRoomCreator && updatedPlayers.length > 0 && room.creatorId === myPlayerId) {
                    updates.creatorId = updatedPlayers[0].id;
                }
                await database.ref('rooms/' + currentRoomCode).update(updates);
            }
        }
        
        currentRoomCode = null;
        isRoomCreator = false;
        isRoomMode = false;
        isGameStartedInRoom = false;
        myPlayerId = null;
        isInputFocused = false; 
        
        hideModal(); 
        resetGame();
    };
    
    const resetGame = (skipRoomCheck = false) => {
        if (isRoomMode && isRoomCreator && !skipRoomCheck) {
            resetRoomGame();
            return;
        }
        
        gameActive = false;
        roles = [];
        secretWord = '';
        imposterHintWord = '';
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = null;
        
        if (!isRoomMode || skipRoomCheck) {
            stopRoomPolling();
            currentRoomCode = null;
            isRoomCreator = false;
            isRoomMode = false;
            isGameStartedInRoom = false;
            myPlayerId = null;
        }
        
        playerNames = Array(playerCount).fill('').map((_, i) => playerNames[i] || '');
        
        renderSetupView();
    };

    const checkUrlForRoom = () => {
         const urlParams = new URLSearchParams(window.location.search);
         const roomCode = urlParams.get('room');
         if (roomCode && roomCode.length === 4) {
             joinRoom(roomCode);
             window.history.replaceState({}, document.title, window.location.pathname);
         }
    };
    
    window.onload = () => {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();

         if (playerNames.length === 0) {
             for (let i = 0; i < playerCount; i++) {
                playerNames.push('');
            }
        }
        renderSetupView();
        checkUrlForRoom();
    };
 </script>
</body>
</html>
