<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title id="main-title">یاری فێڵباز (Imposter)</title>
 <script src="https://cdn.tailwindcss.com"></script>
 
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
 <script>
     tailwind.config = {
         theme: {
             extend: {
                 colors: {
                     'primary': '#facc15',
                     'secondary': '#6366f1',
                     'dark-bg': '#1e293b',
                     'dark-card': '#334155',
                     'input-bg': '#475569',
                 },
                 fontFamily: {
                     'kurdish': ['Scheherazade New', 'sans-serif'],
                 }
             }
         }
     }
 </script>
 <style>
     @import url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap');

     body {
         background-color: #0f172a;
         background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
         background-size: 40px 40px;
         background-position: 0 0, 20px 20px;
         display: flex;
         justify-content: center;
         align-items: center;
         min-height: 100vh;
         padding: 20px;
         font-family: 'kurdish';
     }

     .card {
         background-color: var(--dark-card);
         border-radius: 1.5rem;
         padding: 2.5rem 1.5rem;
         box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
         max-width: 420px;
         width: 100%;
         margin-top: 20px;
         margin-bottom: 20px;
     }

     .title-bar {
         border-bottom: 2px solid rgba(255, 255, 255, 0.1);
         padding-bottom: 0.75rem;
         margin-bottom: 1.5rem;
     }

     input[type="number"], input[type="text"], .input-text-area {
         background-color: var(--input-bg);
         color: #f8fafc;
         border: 1px solid #475569;
         border-radius: 0.5rem;
         padding: 0.5rem 0.75rem;
         width: 100%;
         margin-bottom: 0.75rem;
         text-align: right;
     }

     .primary-btn {
         background: linear-gradient(145deg, #facc15, #eab308);
         color: #1e293b;
         font-weight: 700;
         padding: 0.75rem 1.5rem;
         border-radius: 0.75rem;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.15);
         transition: all 0.2s;
         width: 100%;
     }

     .primary-btn:hover {
         opacity: 0.9;
         transform: translateY(-1px);
         box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
     }
     
     .secondary-btn {
        background: linear-gradient(145deg, #6366f1, #4f46e5);
        color: white;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.15);
        transition: all 0.2s;
        width: 100%;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
     }

     .secondary-btn:hover {
         opacity: 0.9;
         transform: translateY(-1px);
         box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
     }
     
     .back-btn {
         background-color: transparent;
         border: 2px solid #94a3b8;
         color: #94a3b8;
         font-weight: 500;
         padding: 0.5rem 1rem;
         border-radius: 0.5rem;
         transition: all 0.2s;
         width: 100%;
         margin-top: 1rem;
     }
     .back-btn:hover {
        background-color: #334155;
        color: #f8fafc;
     }
     
     .lobby-player-item {
         display: flex;
         justify-content: space-between;
         align-items: center;
         background-color: #475569;
         padding: 0.5rem 1rem;
         border-radius: 0.5rem;
         margin-bottom: 0.5rem;
         color: #f8fafc;
         font-size: 1rem;
     }
     .lobby-player-item.creator {
         border: 2px solid #facc15;
     }
     .lobby-player-item .status {
         font-size: 0.875rem;
         color: #94a3b8;
     }
     .lobby-player-item .status.ready {
         color: #34d399;
         font-weight: 700;
     }
     
     .lobby-player-item .remove-btn {
         background-color: #f87171;
         color: white;
         border: none;
         border-radius: 0.25rem;
         padding: 0.25rem 0.5rem;
         cursor: pointer;
         font-size: 0.75rem;
         font-weight: 700;
         transition: background-color 0.2s;
         margin-right: 0.5rem;
     }
     .lobby-player-item .remove-btn:hover {
         background-color: #ef4444;
     }


     .player-card {
         background-color: #475569;
         border: 1px solid #64748b;
         padding: 20px;
         border-radius: 1rem;
         margin-top: 1.5rem;
         text-align: center;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
         transition: all 0.3s;
     }
   
     .player-card:hover {
         transform: scale(1.02);
     }

     .word-civilian {
         color: #34d399;
     }
     .word-imposter {
         color: #f87171;
     }

     .role-text {
         font-size: 1.5rem;
         font-weight: 700;
         color: var(--primary);
         margin-bottom: 10px;
     }
     .role-text-simplified {
         font-size: 2rem;
         font-weight: 700;
         margin-bottom: 0;
     }

     .word-text {
         font-size: 1.25rem;
         color: #f8fafc;
     }
   
     .footer-text {
         margin-top: 2rem;
         text-align: center;
         font-size: 0.8rem;
         color: #94a3b8;
     }
   
     .footer-text a {
         color: var(--primary);
         text-decoration: none;
         margin-right: 5px;
         margin-left: 5px;
     }
     .footer-text a:hover {
         text-decoration: underline;
     }

     #custom-modal {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.7);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 1000;
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s, visibility 0.3s;
         overflow-y: auto;
     }
     #custom-modal.show {
         opacity: 1;
         visibility: visible;
     }
     .modal-content {
         background-color: var(--dark-card);
         margin: 5% auto; 
         padding: 2rem;
         border-radius: 1rem;
         max-width: 350px;
         width: 90%;
         color: #f8fafc;
         text-align: center;
         box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
         transform: translateY(-50px);
         transition: transform 0.3s;
         max-height: 90vh;
         overflow-y: auto;
         position: relative;
     }
     #custom-modal.show .modal-content {
         transform: translateY(0);
     }
     .modal-title {
         font-size: 1.5rem;
         font-weight: 700;
         color: #facc15;
         margin-bottom: 0.75rem;
     }
     .imposter-popup .modal-title {
        color: #f87171;
        font-size: 2rem;
     }
     .imposter-popup .modal-message {
        font-size: 1.5rem;
        font-weight: bold;
        color: #facc15;
     }
     .modal-message {
         margin-bottom: 1.5rem;
         font-size: 1rem;
         text-align: right;
     }
     .modal-message strong {
         color: #facc15;
     }
     
     .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px; 
        font-size: 1.5rem;
        background: none;
        border: none;
        color: #f8fafc;
        cursor: pointer;
        line-height: 1;
        padding: 5px;
     }
     .rtl .modal-close-btn {
        right: 10px;
        left: auto;
     }
     
     #room-code-display {
         font-family: 'Roboto', monospace;
         font-size: 2.5rem;
         font-weight: 900;
         color: #facc15;
         letter-spacing: 0.2rem;
         margin: 1rem 0;
         text-align: center;
         user-select: all;
     }
     #room-code-label {
         color: #94a3b8;
         font-weight: 700;
         font-size: 1.1rem;
     }
     
     .share-button {
         position: fixed;
         bottom: 20px;
         right: 20px;
         background-color: var(--secondary);
         color: white;
         border: none;
         border-radius: 50%;
         width: 50px;
         height: 50px;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
         z-index: 1000;
         transition: background-color 0.2s, transform 0.2s;
     }
     .share-button:hover {
         background-color: #4f46e5;
         transform: scale(1.05);
     }

     .help-button {
         position: fixed;
         bottom: 20px;
         right: 90px;
         background-color: #34d399;
         color: #1e293b;
         border: none;
         border-radius: 50%;
         width: 50px;
         height: 50px;
         font-size: 1.5rem;
         font-weight: bold;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
         z-index: 1000;
         transition: background-color 0.2s, transform 0.2s;
     }
     .help-button:hover {
         background-color: #10b981;
         transform: scale(1.05);
     }
 </style>
</head>
<body class="rtl" style="--dark-card: #334155; --input-bg: #475569; --primary: #facc15; --secondary: #6366f1;">

 <div id="game-container" class="card">
     </div>

 <div id="custom-modal">
     <div class="modal-content" id="modal-inner">
         </div>
 </div>

 <button id="shareButton" class="share-button" onclick="shareGameLink()">
     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
 </button>

 <button id="helpButton" class="help-button" onclick="showHelpModal()">
    ?
 </button>


 <script>
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", 
        authDomain: "kigbynaseh.firebaseapp.com",
        databaseURL: "https://kigbynaseh-default-rtdb.firebaseio.com",
        projectId: "kigbynaseh",
        storageBucket: "kigbynaseh.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    const modal = document.getElementById('custom-modal');
    const modalInner = document.getElementById('modal-inner');
    const shareButton = document.getElementById('shareButton');
    const helpButton = document.getElementById('helpButton');

    let database;
    let roomRef;
    let myPlayerId = null;

    const WORDS_KU = [
        "پزیشک", "مامۆستا", "ئەندازیار", "فەرمانبەر", "شۆفێر", "گۆرانیبێژ", "نووسەر", "وەرگێڕ",
        "کاسبکار", "وێنەکێش", "باخچەوان", "نانەوا", "گەشتیار", "وەرزشکار", "فرۆشیار", "پۆلیس",
        "سەرباز", "ئاگرکوژێنەر", "بازرگان", "ڕۆژنامەنووس", "جووتیار", "پاسەوان", "قەشە", "ڕاوچی", "شوان", 
        "سەگ", "پشیلە", "کوتر", "ورچ", "گورگ", "ئاسک", "ڕێوی", "شێر", "نەهەنگ", "ئەسپ", "شەمشەمەکوێرە",
        "سمۆرە", "فیل", "مەیموون", "چیمپانزی", "کەر", "مەیمون", "قەلەڕەش", "پەپولە", "مریشک", "قاز", "مەر",
        "مار", "مارمێلکە", "قەل", "کیسەڵ", "تمساح", "بۆق", "ماسی", "قرش", "ئەختەبوت", "زەرافە", "دۆلفین", 
        "خالخالوکە", "مێرولە", "مێش", "کێوریشک", "کوولە", "دووپشک", "مشک", "شیر", "پڵنگ", "کوتر",
        "دار", "گوڵ", "نان", "میوە", "سەوزە", "شاه", "ئیمام", "پێ", "دەست", "ڕەگ", "ئەستێرە", 
        "ریوی", "گەڵا", "تەماتە", "خەیار", "پیاز", "سیر", "قارچک", "مۆز", "فەڕن", "توو", "گژوگیا", "گەنم", "گەنمەشامی",
        "پلەی ستەیشن", "زانا", "پەتاتە", "چای", "قاوە", "شیر", "هەنگوین", "زەیتوون", "روبار", "سروشت", 
        "چیا", "دارستان", "دەریا", "گوند", "شار", "ماڵ", "قوتابخانە", "زانکۆ", "کارگە", "مۆزەخانە", "بیابان",
        "سینەما", "مزگەوت", "حەوش", "قنینە", "قەڵا", "شەقام", "هورن", "تاتو", "ژەهر", "کانی",
        "ئۆتۆمبێل", "فڕۆکە", "شەمەندەفەر", "پاسکیل", "گورگ", "روژ", "هاوڕێ", "دراوسێ", "حوشتر",
        "کەمپی پەنابەران", "ناوچە", "شار", "پایتەخت", "گەراج", "بازاڕ", "دوکان", "قاوەخانە", "کتێبفرۆش",
        "پێلی دەریا", "کریستیانو", "هەتاو", "گوربە", "گڕکان", "گەنجینە", "دەرگا", "پەنجەرە", "مریشک",
        "پەرسیو", "ئاو", "هەور", "باران", "بەفر", "شێرپەنجە", "مانگ", "ئەستێرە", "کتێب", "قەڵەم", "لاپەڕە",
        "مۆبایل", "کۆمپیوتەر", "پیانو", "ئەقل", "چیروک", "بوک", "ڕەنگ", "دەنگ", "بۆن", "تام", "زاوا",
        "تاریک", "گاز", "پەتڕۆڵ", "کارەبا", "مەترسی", "ئاسایش", "دادگا", "یاسا", "سیاسەت", "خەسو", 
        "خەزور", "مێژوو", "جوگرافیا", "فیزیک", "کیمیا", "بیرکاری", "پەروەردە", "مندال", "پیر",
        "مرۆڤ", "هەنجیر", "پرتەقال", "سێو", "بامیە", "خۆشەویست", "دوژمن", "گلێش", "چەقو", "زێر", 
        "بلبل", "ئارد", "مەساسە", "خوێ", "پەتاتە", "موم", "خوێن", "مێشک", "دڵ", "گەدە", "چاو", "گوێ", "دەست", 
        "قاچ", "پێست", "موو", "پێلاو", "نەعال", "ماتۆر", "قەلابه", "فیشەک", "بۆمب", "ڕۆکێت", "شێت", 
        "تەختە", "قوماش", "جام", "قەلەو", "دەمانچە", "حوشتر", "هەوال", "تاوان", "کلیل", "سندوق",
        "بنیشت", "مەلەوانگە", "هوتێل", "شمشێر", "ئاش", "فێلباز", "مولەتی شوفێری", "کابینە", "شوان", "کارەبا", "مردن", "شای"
    ];


    let lang = 'ku';
    let playerCount = 4;
    let imposterCount = 1;
    let playerNames = [];
    let gameActive = false;
    let roles = [];
    let secretWord = '';
    let imposterHintWord = '';

    let isRoomMode = false;
    let currentRoomCode = null;
    let isRoomCreator = false;
    let isGameStartedInRoom = false;
    let isInputFocused = false; 

    let timerInterval;
    let timeLeft;


    const getWordList = () => WORDS_KU;

    const T = (key) => {
        const translations = {
            ku: {
                appName: "یاری فێڵباز", imposter: "فێڵباز", civilian: "هاوڵاتی", playerCount: "ژمارەی یاریزانان (3-12):", imposterCount: "ژمارەی فێڵبازەکان (1-2):", start: "دەستپێکردنی یاری", playerName: "ناوی یاریزان", showRole: "ڕۆڵی خۆت ببینە", yourRole: "ڕۆڵی تۆ:", theWord: "وشەی نهێنی:", madeBy: "Made By Naseh M. Zebari", turn: "نۆرەی یاریزانان", close: "داخستن", reset: "دووبارە دەستپێکردنەوە", wordWas: "وشەی نهێنی بریتی بوو لە:", selectWord: "تکایە وشەی نهێنی هەڵبژێرە!", validationTitle: "هۆشداری", nameRequired: "تکایە ناوی هەموو یاریزانەکان بنووسە.", notEnoughPlayers: "ژمارەی یاریزانان کەمە. پێویستت بە لانی کەم 3 یاریزانە.", impostersWere: "فێڵبازەکان بریتی بوون لە:", justImposter: "تۆ فێڵبازی!", imposterHintLabel: "وشە:", startDiscussion: "دەستپێکردنی گفتوگۆ", discussionTime: "کاتی گفتوگۆ:", timesUp: "کات کۆتایی هات!", imposterWas: "فێڵبازەکە بریتی بوو لە:", shareLink: "لینکی یارییەکە بنێرە بۆ هاوڕێکانت!", and: "و", howToPlayTitle: "چۆن یاری دەکەیت: یاری فێڵباز", howToPlayBody: `ئامانج ئەوەیە هەمووان قەناعەت پێبکەیت کە وشەی نهێنی دەزانیت—یاخود ئەو کەسە بدۆزیتەوە کە نایزانێت.<br><br><strong>١. 🤫 ڕۆڵی خۆت بدۆزەرەوە</strong><br>• مۆبایلەکە بەدەوردا دەسوڕێنرێتەوە بۆ ئەوەی هەمووان بە نهێنی سەیری شاشەکە بکەن.<br>• زۆربەی یاریزانەکان <strong>وشەی نهێنی</strong> دەبینن (بۆ نموونە: قەنەفە).<br>• یەک یاریزان <strong>"فریودەر"</strong> دەبینێت.<br><br><strong>٢. 🗣️ ئاماژە بدە</strong><br>• بە دەوری بازنەکەدا بگەڕێن. هەر یاریزانێک <strong>یەک وشە</strong> بۆ وەسفکردنی وشە نهێنییەکە دەدات.<br>• <strong>ئەگەر وشەکە دەزانیت:</strong> ئاماژەکەت دەبێت ئەوەندە دیاریکراو بێت کە بیسەلمێنێت دەیزانیت، بەڵام ئەوەندەش ناڕوون بێت کە فێڵبازەکە سەرلێشێواو بکات.<br>• <strong>ئەگەر تۆ فێڵبازیت:</strong> ئاماژەیەکی گشتی بدە کە لەگەڵ پۆلەکەدا بگونجێت (بۆ نموونە: کەلوپەل) و هەوڵبدە تێکەڵ ببیت!<br><br><strong>٣. 🗳️ دەنگدان</strong><br>• دوای ٢-٣ گەڕی ئاماژەدان، گفتوگۆ دەستپێدەکات. تۆمەت بخەرە پاڵ ئەو یاریزانەی کە ئاماژەکانی گوماناویترین یان گشتیترین بوون.<br>• هەمووان دەنگ دەدەن بۆ ئەوەی بزانن کێ گوماناوییە. ئەو یاریزانەی زۆرترین دەنگ بەدەست دەهێنێت ئاشکرا دەکرێت.<br><br><strong>چۆن دەیبەیتەوە 🏆 :</strong><br><br>• <strong>هاوڵاتییەکان:</strong><br>-ئەگەر پێش کۆتایی هاتنی کات فێلبازەکە بدۆزنەوە.<br><br>• <strong>فێڵباز:</strong><br>-ئەگەر هاوڵاتییەکان نەیاندۆزنەوە کە کێ فێڵبازە.<br>-ئەگەر کاتەکە کۆتایی بێت.`,
                room: "ژوور", playWithFriends: "یاری لەگەڵ هاوڕێیان", createRoom: "دروستکردنی ژوور", joinRoom: "چوونە ژوورەوە", roomCode: "کۆدی ژوور:", enterCode: "کۆدی ژوور بنووسە", creator: "دروستکەر", myStatus: "دۆخی من:", waitingForName: "چاوەڕێی نووسینی ناو", waitingForOthers: "چاوەڕێی یاریزانانی تر", ready: "ئامادە", submit: "پشتڕاستکردنەوە", notEnoughPlayersPopup: "ژمارەی یاریزانان کەمە. لانی کەم 3 یاریزان پێویستە.", roomFull: "ژوورەکە پڕە.", roomNotFound: "کۆدی ژوورەکە نادروستە.", roomStart: "دەستپێکردنی یاری (3+ یاریزان)", gameAlreadyStarted: "یارییەکە دەستیپێکردووە...", enterYourName: "ناوی خۆت بنووسە", nameSubmitSuccess: "ناوی تۆ نووسرا. چاوەڕێی ئەوانی تر بە.", gameOverTitle: "کۆتایی یاری", playAgain: "دووبارە یاری بکەوە لە هەمان ژوور", exitRoom: "چوونە دەرەوەی ژوور", startOver: "دەستپێکی دووبارە (وشە و ڕۆڵی نوێ)", backToSetup: "گەڕانەوە بۆ ڕێکخستنەکان",
                finishTheTimer: "کۆتایی هێنان بە کات", remove: "لابردن" // Added translation for 'remove'
            }
        };
        return translations.ku[key] || key;
    };
    
    const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    };

    const showModal = (titleKey, messageKey, isImposterReveal = false, customContent = null, closeCallback = hideModal) => {
        const title = T(titleKey);
        let message = T(messageKey);
        
        if(isImposterReveal) {
             message = messageKey;
        }
        
        modalInner.className = 'modal-content ' + (isImposterReveal ? 'imposter-popup' : '');
        modalInner.innerHTML = `
            <button class="modal-close-btn" onclick="${closeCallback.name}()">×</button>
            <h3 class="modal-title">${title}</h3>
            <div class="modal-message">
                ${customContent || message}
            </div>
            ${!isImposterReveal ? `<button class="primary-btn" onclick="${closeCallback.name}()">
                ${T('close')}
            </button>` : `<button class="primary-btn mt-4" onclick="${closeCallback.name}()">
                ${T('close')}
            </button>`}
        `;
        modal.classList.add('show');
    };

    const hideModal = () => {
        modal.classList.remove('show');
    };

    const shareGameLink = async () => {
        if (!currentRoomCode && isRoomMode) return;
        
        let url = window.location.href.split('?')[0];
        let shareText = T('shareLink');
        
        if (isRoomMode) {
           url = url + `?room=${currentRoomCode}`;
           shareText = `${T('roomCode')} ${currentRoomCode}. ${T('shareLink')}`;
        }
        
        if (navigator.share) {
            try {
                await navigator.share({
                    title: T('appName'),
                    text: shareText,
                    url: url
                });
            } catch (error) {
                await navigator.clipboard.writeText(url);
                showModal('roomCode', `${isRoomMode ? currentRoomCode : url}<br><br><strong>${T('shareLink')}</strong>`);
            }
        } else {
            await navigator.clipboard.writeText(url);
            showModal('roomCode', `${isRoomMode ? currentRoomCode : url}<br><br><strong>${T('shareLink')}</strong>`);
        }
    };

    const showHelpModal = () => {
        showModal('howToPlayTitle', 'howToPlayBody', false, T('howToPlayBody'));
    };

    const getRoomSnapshot = async (code) => {
        try {
            const snapshot = await database.ref('rooms/' + code).once('value');
            return snapshot.val();
        } catch (error) {
            console.error("Error getting room snapshot:", error);
            return null;
        }
    };

    const startRoomPolling = () => {
        if (!currentRoomCode) return;
        
        if (roomRef) roomRef.off('value', pollRoomCallback);

        roomRef = database.ref('rooms/' + currentRoomCode);
        
        roomRef.on('value', pollRoomCallback, (error) => {
            console.error("Firebase listener error:", error);
            if (currentRoomCode) {
                showModal('validationTitle', 'roomNotFound', false, null, resetGame);
            }
        });
    };

    const stopRoomPolling = () => {
        if (roomRef) {
            roomRef.off('value', pollRoomCallback);
            roomRef = null;
        }
    };
    
    const pollRoomCallback = (snapshot) => {
        const room = snapshot.val();
        
        if (!room) {
            stopRoomPolling();
            if (currentRoomCode) {
                showModal('validationTitle', 'roomNotFound', false, null, resetGame);
            }
            return;
        }
        
        if (isInputFocused) {
           return;
        }

        if (myPlayerId && !room.players.some(p => p.id === myPlayerId)) {
            stopRoomPolling();
            resetGame();
            return;
        }
        
        isRoomCreator = room.creatorId === myPlayerId; // Update creator status on poll
        imposterCount = room.imposterCount;
        playerCount = room.players.length;
        
        const myPlayerData = room.players.find(p => p.id === myPlayerId);
        if (myPlayerData) {
             roles = room.players;
             secretWord = room.secretWord;
             imposterHintWord = room.imposterHintWord;
        }


        if (room.gameState === 'playing' && !isGameStartedInRoom) {
            isGameStartedInRoom = true;
            startGame(room);
        } else if (room.gameState === 'ended' && isGameStartedInRoom) {
            renderGameOverModal();
        } else if (room.gameState === 'setup') {
            if (!isGameStartedInRoom) {
               renderRoomLobby(room);
            } else {
                 isGameStartedInRoom = false;
                 roles = [];
                 clearInterval(timerInterval);
                 timerInterval = null;
                 timeLeft = null;
                 renderRoomLobby(room);
            }
        } else if (room.gameState === 'playing' && isGameStartedInRoom) {
            renderEndGameView(true);
        }
    };

    const generateRoomCode = () => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let code = '';
        for (let i = 0; i < 4; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    };

    const createRoom = async () => {
        let code = generateRoomCode();
        let existingRoom = await getRoomSnapshot(code);
        while (existingRoom) {
            code = generateRoomCode();
            existingRoom = await getRoomSnapshot(code);
        }
        
        myPlayerId = database.ref().push().key; 
        
        const newRoom = {
            code: code,
            creatorId: myPlayerId,
            imposterCount: 1,
            players: [
                { id: myPlayerId, name: '', isReady: false, role: '', word: '' }
            ],
            gameState: 'setup',
            secretWord: '',
            imposterHintWord: '',
            discussionStartTime: null,
            discussionDuration: 0
        };
        
        roomRef = database.ref('rooms/' + code);
        await roomRef.set(newRoom);
        
        currentRoomCode = code;
        isRoomCreator = true;
        isRoomMode = true;
        
        renderRoomLobby(newRoom);
        startRoomPolling();
    };

    const joinRoom = async (code) => {
        code = code.toUpperCase();
        const room = await getRoomSnapshot(code);
        
        if (!room) {
            showModal('validationTitle', 'roomNotFound');
            return;
        }
        if (room.players.length >= 12) {
            showModal('validationTitle', 'roomFull');
            return;
        }
        if (room.gameState !== 'setup') {
            showModal('validationTitle', 'gameAlreadyStarted');
            return;
        }
        
        myPlayerId = database.ref().push().key; 
        const newPlayer = { id: myPlayerId, name: '', isReady: false, role: '', word: '' };
        
        roomRef = database.ref('rooms/' + code);
        room.players.push(newPlayer);
        await roomRef.update({ players: room.players });
        
        currentRoomCode = code;
        isRoomCreator = room.creatorId === myPlayerId;
        isRoomMode = true;
        
        renderRoomLobby(room);
        startRoomPolling();
    };

    const submitName = async () => {
        const nameInput = document.getElementById('my-name-input');
        const myName = nameInput.value.trim();
        
        if (myName.length < 1) {
            showModal('validationTitle', 'nameRequired');
            return;
        }
        
        isInputFocused = true;
        const room = await getRoomSnapshot(currentRoomCode);
        isInputFocused = false;
        if (!room) return;

        const myPlayerIndex = room.players.findIndex(p => p.id === myPlayerId);
        if (myPlayerIndex !== -1) {
            room.players[myPlayerIndex].name = myName;
            room.players[myPlayerIndex].isReady = true;
            
            await roomRef.update({ players: room.players });
            
            showModal('validationTitle', 'nameSubmitSuccess', false, null, hideModal);
        }
    };
    
    const updateRoomSettings = async (imposterValue) => {
        if (!isRoomCreator) return;
        
        let count = parseInt(imposterValue);
        const room = await getRoomSnapshot(currentRoomCode);
        
        if (!room) return;

        if (isNaN(count) || count < 1) count = 1;
        if (count > 2) count = 2;
        if (count >= room.players.length && room.players.length > 1) {
            count = room.players.length - 1;
        }
        if (count < 1 && room.players.length > 0) count = 1;

        if (roomRef) {
            await roomRef.update({ imposterCount: count });
            imposterCount = count;
        }
    };

    // New function to remove a player
    const removePlayerFromRoom = async (playerIdToRemove) => {
        if (!isRoomCreator || playerIdToRemove === myPlayerId) return; 

        isInputFocused = true;
        const room = await getRoomSnapshot(currentRoomCode);
        isInputFocused = false;
        if (!room) return;

        const updatedPlayers = room.players.filter(p => p.id !== playerIdToRemove);

        if (updatedPlayers.length === 0) {
            await database.ref('rooms/' + currentRoomCode).remove();
        } else {
            let updates = { players: updatedPlayers };
            // If the removed player was the creator, assign new creator (the first player in the list)
            if (room.creatorId === playerIdToRemove) {
                 updates.creatorId = updatedPlayers[0].id;
            }
            await database.ref('rooms/' + currentRoomCode).update(updates);
        }
    };


    const startRoomGame = async () => {
        const room = await getRoomSnapshot(currentRoomCode);
        if (!room || room.players.length < 3) {
            renderNotEnoughPlayersModal();
            return;
        }
        
        const readyPlayers = room.players.filter(p => p.isReady && p.name);
        if (readyPlayers.length < room.players.length) {
            showModal('validationTitle', 'nameRequired');
            return;
        }
        
        const wordList = getWordList();
        const secretIndex = Math.floor(Math.random() * wordList.length);
        const newSecretWord = wordList[secretIndex];
        const newImposterHintWord = T('justImposter');
        
        const imposterIndices = [];
        while (imposterIndices.length < room.imposterCount) {
            const index = Math.floor(Math.random() * readyPlayers.length);
            if (!imposterIndices.includes(index)) {
                imposterIndices.push(index);
            }
        }
        
        let rolesList = readyPlayers.map((p, i) => {
            const isImposter = imposterIndices.includes(i);
            const role = isImposter ? T('imposter') : T('civilian');
            const wordContent = isImposter ? newImposterHintWord : newSecretWord;
            
            return {
                ...p,
                role: role,
                word: wordContent,
                name: p.name.trim(),
            };
        });

        rolesList = rolesList.sort(() => Math.random() - 0.5);
        
        room.players = rolesList;
        room.secretWord = newSecretWord;
        room.imposterHintWord = newImposterHintWord;
        room.gameState = 'playing';
        
        roles = rolesList;

        await roomRef.update({
            players: room.players,
            secretWord: room.secretWord,
            imposterHintWord: room.imposterHintWord,
            gameState: room.gameState
        });

        isGameStartedInRoom = true;
        startGame(room);
    };

    const resetRoomGame = async () => {
        const room = await getRoomSnapshot(currentRoomCode);
        if (!room) return;
        
        const updates = {
            gameState: 'setup',
            secretWord: '',
            imposterHintWord: '',
            discussionStartTime: null,
            discussionDuration: 0,
            players: room.players.map(p => ({ ...p, isReady: false, role: '', word: '' }))
        };
        
        await roomRef.update(updates);
        
        isGameStartedInRoom = false;
        roles = [];
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = null;
        
        hideModal();
    };

    const finishRoomTimer = async () => {
        if (!isRoomMode || !isRoomCreator) return;
        
        if (roomRef) {
            clearInterval(timerInterval);
            timerInterval = null;
            timeLeft = 0;
            await roomRef.update({ gameState: 'ended' });
            renderGameOverModal();
        }
    };
    
    const finishLocalTimer = () => {
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = 0;
        
        // --- نوێکراوە بۆ دۆخی ئاسایی ---
        document.getElementById('timerDisplay').textContent = T('timesUp');
        
        const imposterNames = roles
            .filter(r => r.role === T('imposter'))
            .map(r => r.name);
        const imposterList = imposterNames.join(' ' + T('and') + ' ');
        
        const message = `
            <div class="text-right">
                <p class="text-lg text-slate-300 mb-2">${T('wordWas')}</p>
                <p class="text-2xl font-bold text-primary mb-4">${secretWord}</p>
                <p class="text-lg text-slate-300 mb-2">${T('impostersWere')}</p>
                <p class="text-2xl font-bold word-imposter">${imposterList}</p>
            </div>
        `;
        showModal('gameOverTitle', '', true, message);
    }

    const timerFinished = async () => {
        clearInterval(timerInterval);
        timerInterval = null;
        
        if(isRoomMode) {
            if(isRoomCreator) {
                await roomRef.update({ gameState: 'ended' });
                renderGameOverModal();
            }
        } else {
            finishLocalTimer();
        }
    }

    const countdown = () => {
        if (timeLeft <= 0) {
            timerFinished();
        } else {
            timeLeft--;
            const timerEl = document.getElementById('timerDisplay');
            if(timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
        }
    }
    
    const startDiscussion = async () => {
        if (timerInterval) return;

        const duration = playerCount * 60;

        if (isRoomMode) {
            if (isRoomCreator) {
                const room = await getRoomSnapshot(currentRoomCode);
                if (room && room.gameState === 'playing') {
                    
                    await roomRef.update({
                        discussionStartTime: firebase.database.ServerValue.TIMESTAMP,
                        discussionDuration: duration
                    });
                    
                    timeLeft = duration;
                    timerInterval = setInterval(countdown, 1000); 
                    
                    const startButton = document.getElementById('startDiscussionButton');
                    if(startButton) {
                       startButton.textContent = T('discussionTime');
                       startButton.disabled = true;
                    }
                    const timerEl = document.getElementById('timerDisplay');
                    if(timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
                    
                    const endBtn = document.getElementById('finishLocalTimerButton');
                    if(endBtn) endBtn.classList.remove('hidden');
                }
            }
        } else {
            timeLeft = duration; 
            const startButton = document.getElementById('startDiscussionButton');
            startButton.textContent = T('discussionTime');
            startButton.disabled = true;
            document.getElementById('timerDisplay').textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
            timerInterval = setInterval(countdown, 1000); 
            
            // --- نوێکراوە بۆ دۆخی ئاسایی ---
            const endBtn = document.getElementById('finishLocalTimerButton');
            if(endBtn) endBtn.classList.remove('hidden');
        }
    };
    
    const renderEndGameView = (isRoom = false) => {
        const container = document.getElementById('game-container');
        
        const initialTime = playerCount * 60;
        const initialTimeFormatted = formatTime(initialTime);
        let displayTime = timerInterval ? `${T('discussionTime')} ${formatTime(timeLeft)}` : `${T('discussionTime')} ${initialTimeFormatted}`;
        
        
        if (isRoom && roomRef && !isRoomCreator) {
            roomRef.once('value').then(snapshot => {
                const room = snapshot.val();
                const timerEl = document.getElementById('timerDisplay');
                
                if(room && room.discussionStartTime && room.discussionDuration) {
                    const elapsed = Date.now() - room.discussionStartTime;
                    const remaining = room.discussionDuration * 1000 - elapsed;
                    
                    if(remaining > 0) {
                        timeLeft = Math.ceil(remaining / 1000);
                        if (timerEl) timerEl.textContent = `${T('discussionTime')} ${formatTime(timeLeft)}`;
                        if (!timerInterval) {
                             timerInterval = setInterval(countdown, 1000); 
                        }
                    } else {
                         if (timerEl) timerEl.textContent = T('timesUp');
                    }
                } else {
                     if (timerEl) timerEl.textContent = T('waitingForOthers');
                }
            });
            displayTime = T('waitingForOthers');
        }
        
        if (isRoom && !isRoomCreator) {
            const roomData = roles.find(p => p.id === myPlayerId);
             if (roomData && roomData.role) {
                secretWord = roles.find(p => p.role === T('civilian'))?.word || '';
                imposterHintWord = T('justImposter');
                
                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                    <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')}</h2>
                    <div class="title-bar mb-6"></div>
                    
                    <div class="player-card">
                        <p class="text-lg text-slate-300 mb-2">${roomData.name}</p>
                        <p class="role-text-simplified ${roomData.role === T('imposter') ? 'word-imposter' : 'word-civilian'}">
                           ${roomData.role === T('imposter') ? T('justImposter') : roomData.word}
                        </p>
                    </div>

                    <p id="timerDisplay" class="text-2xl text-slate-200 text-center mt-6 mb-4">${displayTime}</p>
                    <button id="startDiscussionButton" class="primary-btn mb-6 opacity-50 cursor-not-allowed" 
                            disabled style="background: linear-gradient(145deg, #6366f1, #4f46e5); color: white;">
                        ${T('startDiscussion')}
                    </button>
                    <p class="text-sm text-center text-slate-400">${T('waitingForOthers')}</p>
                    
                    <div class="mt-8">
                        <button class="back-btn mt-2" onclick="exitRoom()">
                            ${T('exitRoom')}
                        </button>
                    </div>
                    <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
                `;
                return;
            }
        }
        
        container.innerHTML = `
             <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
             <h2 id="timerDisplay" class="text-2xl text-slate-200 text-center mb-6">${displayTime}</h2>
             <div class="title-bar mb-6"></div>

             <button id="startDiscussionButton" class="primary-btn mb-6 ${isRoom && !isRoomCreator ? 'opacity-50 cursor-not-allowed' : ''}" 
                     onclick="startDiscussion()" 
                     ${isRoom && !isRoomCreator ? 'disabled' : ''}
                     style="background: linear-gradient(145deg, #6366f1, #4f46e5); color: white;">
                 ${T('startDiscussion')}
             </button>

             ${isRoom && isRoomCreator ? `
                 <button class="primary-btn secondary-btn mb-4" onclick="finishRoomTimer()" style="background: linear-gradient(145deg, #f87171, #ef4444); color: white;">
                     ${T('finishTheTimer')}
                 </button>
             ` : !isRoom ? `
                 <button id="finishLocalTimerButton" class="primary-btn secondary-btn mb-4 hidden" onclick="finishLocalTimer()" style="background: linear-gradient(145deg, #f87171, #ef4444); color: white;">
                     ${T('finishTheTimer')}
                 </button>
             ` : ''}

             <div class="mt-8">
                 ${isRoom ? `
                    <button class="primary-btn bg-secondary hover:bg-indigo-600 mb-4" onclick="resetRoomGame()" ${!isRoomCreator ? 'disabled' : ''} style="background: linear-gradient(145deg, #facc15, #eab308); color: #1e293b;">
                         ${T('startOver')}
                     </button>
                    <button class="back-btn mt-2" onclick="exitRoom()">
                        ${T('exitRoom')}
                    </button>
                 ` : `
                    <button class="primary-btn bg-secondary hover:bg-indigo-600" onclick="resetGame()" style="background: linear-gradient(145deg, #facc15, #eab308); color: #1e293b;">
                         ${T('reset')}
                     </button>
                 `}
             </div>
           
             <div class="footer-text mt-8">
                 ${T('madeBy')}
                 <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
             </div>
         `;
         
         if(timerInterval) {
             const startButton = document.getElementById('startDiscussionButton');
             if(startButton) {
                 startButton.textContent = T('discussionTime');
                 startButton.disabled = true;
             }
             const endBtn = document.getElementById('finishLocalTimerButton');
             if(endBtn && !isRoom) endBtn.classList.remove('hidden');
         }
    };
    
    const getNamesFromDOM = () => {
         const inputs = document.querySelectorAll('#player-names-input input[type="text"]');
         playerNames = Array.from(inputs).map(input => input.value.trim());
         return playerNames;
    };
    
    const startGame = (roomData = null) => {
        hideModal();
        gameActive = true;
        
        if (roomData) {
            isRoomMode = true;
            roles = roomData.players;
            playerCount = roles.length;
            imposterCount = roomData.imposterCount;
            secretWord = roomData.secretWord;
            imposterHintWord = roomData.imposterHintWord;
            
            const myPlayerIndex = roles.findIndex(p => p.id === myPlayerId);
            renderRoomGameView(myPlayerIndex);
            
        } else {
            playerNames = getNamesFromDOM().filter(n => n.length > 0);
            playerCount = playerNames.length;
            
            if (playerCount < 3) {
                 renderNotEnoughPlayersModal();
                 gameActive = false;
                 return;
            }
            if (playerNames.some(name => name.length < 1)) {
                 showModal('validationTitle', 'nameRequired');
                 gameActive = false;
                 return;
            }

            const wordList = getWordList();
            const secretIndex = Math.floor(Math.random() * wordList.length);
            secretWord = wordList[secretIndex];
            imposterHintWord = T('justImposter');
            
            const imposterIndices = [];
            while (imposterIndices.length < imposterCount) {
                const index = Math.floor(Math.random() * playerCount);
                if (!imposterIndices.includes(index)) {
                    imposterIndices.push(index);
                }
            }
            
            roles = playerNames.map((name, i) => {
                const isImposter = imposterIndices.includes(i);
                return {
                    name: name,
                    role: isImposter ? T('imposter') : T('civilian'),
                    word: isImposter ? imposterHintWord : secretWord
                };
            }).sort(() => Math.random() - 0.5);

            renderPlayerTurnView(0);
        }
    };

    const showRole = (playerIndex) => {
        const roleData = isRoomMode ? roles.find(p => p.id === myPlayerId) : roles[playerIndex];
        
        if (!roleData) return;
        
        const isImposter = roleData.role === T('imposter');
        const roleContent = isImposter 
            ? `<p class="role-text-simplified word-imposter">${T('justImposter')}</p>`
            : `<p class="role-text-simplified word-civilian">${roleData.word}</p>`;

        const container = isRoomMode ? document.getElementById('room-player-turn') : document.getElementById('player-turn-view');
        
        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('yourRole')}</h2>
            <div class="title-bar mb-6"></div>

            <div class="player-card">
                <p class="text-lg text-slate-300 mb-2">${roleData.name}</p>
                ${roleContent}
            </div>
            
            <button class="primary-btn mt-6" onclick="hideRole(${playerIndex})">
                ${T('close')}
            </button>
        `;
    };

    const hideRole = (playerIndex) => {
        if (isRoomMode) {
            renderEndGameView(true);
        } else if (playerIndex < roles.length - 1) {
            renderPlayerTurnView(playerIndex + 1);
        } else {
            renderEndGameView(false);
        }
    };
    
    const renderPlayerTurnView = (playerIndex = 0) => {
        const container = document.getElementById('game-container');
        const currentPlayer = roles[playerIndex];
        const totalPlayers = roles.length;

        container.innerHTML = `
            <div id="player-turn-view">
                <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')} ${playerIndex + 1}/${totalPlayers}</h2>
                <div class="title-bar mb-6"></div>

                <div class="player-card">
                    <p class="text-lg text-slate-300 mb-2">${T('playerName')}:</p>
                    <p class="text-3xl font-bold text-primary">${currentPlayer.name}</p>
                </div>

                <button class="primary-btn mt-6" onclick="showRole(${playerIndex})">
                    ${T('showRole')}
                </button>
                
                <button class="back-btn" onclick="resetGame()">
                    ${T('backToSetup')}
                </button>
                 <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
            </div>
        `;
    };
    
    const renderRoomGameView = (myPlayerIndex) => {
        const container = document.getElementById('game-container');
        const myPlayerData = roles.find(p => p.id === myPlayerId);
        
        if (!myPlayerData) return;

        container.innerHTML = `
            <div id="room-player-turn">
                <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
                <h2 class="text-xl font-bold text-center text-slate-300 mb-6">${T('turn')}</h2>
                <div class="title-bar mb-6"></div>

                <div class="player-card">
                    <p class="text-lg text-slate-300 mb-2">${T('playerName')}:</p>
                    <p class="text-3xl font-bold text-primary">${myPlayerData.name}</p>
                </div>

                <button class="primary-btn mt-6" onclick="showRole(${myPlayerIndex})">
                    ${T('showRole')}
                </button>
                
                <button class="back-btn" onclick="exitRoom()">
                    ${T('exitRoom')}
                </button>
                 <div class="footer-text mt-8">${T('madeBy')} <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a></div>
            </div>
        `;
    };
    
    const renderGameOverModal = () => {
        const imposterNames = roles
            .filter(r => r.role === T('imposter'))
            .map(r => r.name);
        const imposterList = imposterNames.join(' ' + T('and') + ' ');
        
        const message = `
            <div class="text-right">
                <p class="text-lg text-slate-300 mb-2">${T('wordWas')}</p>
                <p class="text-2xl font-bold text-primary mb-4">${secretWord}</p>
                <p class="text-lg text-slate-300 mb-2">${T('impostersWere')}</p>
                <p class="text-2xl font-bold word-imposter">${imposterList}</p>
            </div>
            <button class="primary-btn mt-6 mb-2" onclick="${isRoomCreator ? 'resetRoomGame()' : 'hideModal()'}">
                ${isRoomCreator ? T('playAgain') : T('close')}
            </button>
            <button class="back-btn mt-2" onclick="exitRoom()">
                ${T('exitRoom')}
            </button>
        `;

        showModal('gameOverTitle', '', true, message, hideModal);
    };

    const renderNotEnoughPlayersModal = () => {
        showModal('validationTitle', 'notEnoughPlayersPopup');
    };

    const renderSetupView = () => {
        isRoomMode = false;
        gameActive = false;
        helpButton.classList.remove('hidden');

        const container = document.getElementById('game-container');
        
        if (playerNames.length !== playerCount) {
             playerNames = Array(playerCount).fill('').map((_, i) => playerNames[i] || '');
        }

        const nameInputs = playerNames.map((name, index) => `
            <input type="text" placeholder="${T('playerName')} ${index + 1}" value="${name}" 
                   onfocus="isInputFocused = true" 
                   onblur="isInputFocused = false" 
                   onchange="getNamesFromDOM()">
        `).join('');

        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <p class="text-slate-300 mb-2 text-right">${T('playerCount')}</p>
            <input type="number" min="3" max="12" value="${playerCount}" onchange="handlePlayerCountChange(event)" class="mb-4">

            <p class="text-slate-300 mb-2 text-right">${T('imposterCount')}</p>
            <input type="number" min="1" max="2" value="${imposterCount}" onchange="handleImposterCountChange(event)" class="mb-6">

            <div id="player-names-input">
                <p class="text-slate-300 mb-2 text-right">${T('playerName')} ${T('and')} ${T('playerName')}:</p>
                ${nameInputs}
            </div>

            <button class="primary-btn mt-6" onclick="startGame()">
                ${T('start')}
            </button>
            
            <button class="secondary-btn" onclick="renderRoomMenu()">
                ${T('playWithFriends')}
            </button>
            
            <div class="footer-text">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const handlePlayerCountChange = (event) => {
         let count = parseInt(event.target.value);
         if (isNaN(count) || count < 3) count = 3;
         if (count > 12) count = 12;
         playerCount = count;
         if (imposterCount >= count) {
             imposterCount = count > 1 ? 1 : 1;
         }
         
         if (playerNames.length > playerCount) {
             playerNames = playerNames.slice(0, playerCount);
         } else if (playerNames.length < playerCount) {
             for (let i = playerNames.length; i < playerCount; i++) {
                 playerNames.push('');
             }
         }
         renderSetupView();
     };

     const handleImposterCountChange = (event) => {
         let count = parseInt(event.target.value);
         if (isNaN(count) || count < 1) count = 1;
         if (count > 2 || count >= playerCount) count = Math.min(2, playerCount - 1);
         imposterCount = count;
         renderSetupView();
     };

    const renderRoomMenu = () => {
        const container = document.getElementById('game-container');
        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <button class="secondary-btn mb-4" onclick="createRoom()">
                ${T('createRoom')}
            </button>
            
            <p class="text-slate-300 mb-2 text-right">${T('enterCode')}</p>
            <input type="text" id="join-code-input" placeholder="ABCD" maxlength="4" onfocus="isInputFocused = true" onblur="isInputFocused = false">
            
            <button class="primary-btn" onclick="joinRoom(document.getElementById('join-code-input').value)">
                ${T('joinRoom')}
            </button>
            
            <button class="back-btn" onclick="renderSetupView()">
                ${T('backToSetup')}
            </button>
            
            <div class="footer-text mt-8">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const copyRoomCode = async () => {
        if (currentRoomCode) {
            await navigator.clipboard.writeText(currentRoomCode);
            showModal('roomCode', `${currentRoomCode}<br><br><strong>${T('shareLink')}</strong>`);
        }
     };

    const renderRoomLobby = (room) => {
        currentRoomCode = room.code;
        isRoomCreator = room.creatorId === myPlayerId;
        
        const myPlayerData = room.players.find(p => p.id === myPlayerId) || { name: '', isReady: false };
        const myPlayerName = myPlayerData.name;
        const myStatusKey = myPlayerData.name ? (myPlayerData.isReady ? 'ready' : 'waitingForOthers') : 'waitingForName';
        
        const container = document.getElementById('game-container');
        
        shareButton.classList.remove('hidden');

        const playerListHTML = room.players.map(p => {
            const isCreator = p.id === room.creatorId;
            const isMe = p.id === myPlayerId;
            const statusText = p.isReady ? T('ready') : T('waitingForName');
            const statusClass = p.isReady ? 'ready' : '';
            
            // Add remove button for creator, but not for themselves
            const removeButton = isRoomCreator && !isMe ? 
                `<button class="remove-btn" onclick="removePlayerFromRoom('${p.id}')">${T('remove')}</button>` : 
                '';
            
            return `
                <div class="lobby-player-item ${isCreator ? 'creator' : ''}">
                    <div class="flex items-center">
                        ${removeButton}
                        <span class="font-bold">${p.name || T('waitingForName')} ${isCreator ? `(${T('creator')})` : ''}</span>
                    </div>
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
            `;
        }).join('');

        const isMinimumPlayers = room.players.length >= 3;
        const allPlayersReady = room.players.every(p => p.isReady && p.name);

        container.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-primary mb-4">${T('appName')}</h1>
            <div class="title-bar mb-6"></div>
            
            <p id="room-code-label">${T('roomCode')}</p>
            <p id="room-code-display" onclick="copyRoomCode()">${room.code}</p>
            <p class="text-sm text-slate-400 text-center mb-6">${T('shareLink')}</p>
            
            <div class="flex justify-between items-center text-slate-300 mb-4">
                <p><strong>${T('myStatus')}</strong></p>
                <p class="status ${myStatusKey === 'ready' ? 'ready' : ''}">${T(myStatusKey)}</p>
            </div>
            
            <p class="text-slate-300 mb-2 text-right">${T('enterYourName')}</p>
            <div class="flex gap-2">
                <input type="text" id="my-name-input" placeholder="${T('playerName')}" value="${myPlayerName}" 
                       onfocus="isInputFocused = true" 
                       onblur="isInputFocused = false" 
                       class="flex-grow">
                <button class="primary-btn w-auto px-6 py-2" onclick="submitName()">
                    ${T('submit')}
                </button>
            </div>

            ${isRoomCreator ? `
                <div class="mt-4">
                    <p class="text-slate-300 mb-2 text-right">${T('imposterCount')}</p>
                    <input type="number" min="1" max="2" value="${room.imposterCount}" 
                           onchange="updateRoomSettings(this.value)" class="mb-4">
                </div>
            ` : `<p class="text-slate-400 text-sm mt-4 text-center">${T('imposterCount')}: ${room.imposterCount}</p>`}

            <div class="mt-6 mb-4 max-h-40 overflow-y-auto pr-1">
                ${playerListHTML}
            </div>

            <button class="primary-btn mt-4 ${!isMinimumPlayers || !allPlayersReady || !isRoomCreator ? 'opacity-50 cursor-not-allowed' : ''}" 
                    onclick="startRoomGame()" ${!isMinimumPlayers || !allPlayersReady || !isRoomCreator ? 'disabled' : ''}>
                ${T('roomStart')}
            </button>
            
            <button class="back-btn" onclick="exitRoom()">
                ${T('exitRoom')}
            </button>
            
            <div class="footer-text mt-8">
                ${T('madeBy')}
                <a href="https://www.instagram.com/n4.5e7/" target="_blank" class="hover:text-primary">@n4.5e7</a>
            </div>
        `;
    };
    
    const exitRoom = async () => {
        if (!currentRoomCode) {
            resetGame();
            return;
        }
        
        stopRoomPolling();
        
        const room = await getRoomSnapshot(currentRoomCode);
        if (room) {
            const updatedPlayers = room.players.filter(p => p.id !== myPlayerId);
            
            if (updatedPlayers.length === 0) {
                await database.ref('rooms/' + currentRoomCode).remove();
            } else {
                let updates = { players: updatedPlayers };
                if (isRoomCreator && updatedPlayers.length > 0 && room.creatorId === myPlayerId) {
                    updates.creatorId = updatedPlayers[0].id;
                }
                await database.ref('rooms/' + currentRoomCode).update(updates);
            }
        }
        
        currentRoomCode = null;
        isRoomCreator = false;
        isRoomMode = false;
        isGameStartedInRoom = false;
        myPlayerId = null;
        isInputFocused = false; 
        
        hideModal(); 
        resetGame();
    };
    
    const resetGame = (skipRoomCheck = false) => {
        if (isRoomMode && isRoomCreator && !skipRoomCheck) {
            resetRoomGame();
            return;
        }
        
        gameActive = false;
        roles = [];
        secretWord = '';
        imposterHintWord = '';
        clearInterval(timerInterval);
        timerInterval = null;
        timeLeft = null;
        
        if (!isRoomMode || skipRoomCheck) {
            stopRoomPolling();
            currentRoomCode = null;
            isRoomCreator = false;
            isRoomMode = false;
            isGameStartedInRoom = false;
            myPlayerId = null;
        }
        
        playerNames = Array(playerCount).fill('').map((_, i) => playerNames[i] || '');
        
        renderSetupView();
    };

    const checkUrlForRoom = () => {
         const urlParams = new URLSearchParams(window.location.search);
         const roomCode = urlParams.get('room');
         if (roomCode && roomCode.length === 4) {
             joinRoom(roomCode);
             window.history.replaceState({}, document.title, window.location.pathname);
         }
    };
    
    window.onload = () => {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();

         if (playerNames.length === 0) {
             for (let i = 0; i < playerCount; i++) {
                playerNames.push('');
            }
        }
        renderSetupView();
        checkUrlForRoom();
    };
 </script>
</body>
</html>
