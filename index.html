<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title id="main-title">یاری فریودەر (Imposter)</title>
   <script src="https://cdn.tailwindcss.com"></script>
   
   <style>
       /* PROFESSIONAL DESIGN & TYPOGRAPHY */
       /* Corrected Font Stack for full Kurdish (Sorani) character support: گ، ڤ، ژ, etc. */
       @import url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700;900&display=swap');
       @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

       /* Color Palette (Refined) */
       :root {
           --color-primary: #facc15;      /* Gold/Yellow */
           --color-secondary: #0c4a6e;    /* Dark Cyan */
           --color-background: #020617;   /* Deep Black/Blue */
           --color-card: #1f2937;         /* Dark Gray Card */
           --color-text: #f3f4f6;         /* Off-White Text */
           --color-success: #10b981;      /* Emerald Green */
           --color-danger: #ef4444;       /* Bright Red */
           --color-initial-text: #9ca3af; /* Subtle Gray */
           --color-input-bg: #374151;     /* Medium Gray for Inputs */
           --color-input-border: #4b5563; /* Darker Gray Border */
           --color-cheat-button: #7e22ce; /* Deep Purple */
       }

       body { 
           /* CORRECTED FONT STACK FOR KURDISH SUPPORT */
           font-family: 'Scheherazade New', 'NRT', 'Tahoma', 'Arial', sans-serif; 
           display: flex; 
           justify-content: center; 
           align-items: center; 
           min-height: 100vh; 
           background-color: var(--color-background); 
           color: var(--color-text); 
           padding: 20px 10px; 
           text-align: right; 
           background-image: radial-gradient(circle at center, #172554 1px, transparent 1px);
           background-size: 50px 50px;
       }
       .container { 
           max-width: 450px; 
           width: 100%; 
           padding: 30px; 
           background: var(--color-card); 
           border-radius: 20px; 
           box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 50px rgba(250, 204, 21, 0.1); 
           border: 2px solid rgba(250, 204, 21, 0.2);
           transition: all 0.3s ease-in-out;
       }
       
       /* Language-specific font and direction handling */
       .lang-en * {
            font-family: 'Roboto', 'Arial', sans-serif !important;
       }
       .lang-en {
            direction: ltr;
            text-align: left;
       }
       
       h1 { 
           font-weight: 900; 
           font-size: 2rem; 
           margin-bottom: 20px;
           color: var(--color-primary);
           text-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
           text-align: center; 
       }
       h2 { 
           font-weight: 700; 
           font-size: 1.5rem; 
           margin-top: 15px; 
           margin-bottom: 15px; 
           color: var(--color-text);
       }
       
       /* Input Field Styling */
       input[type="number"], select, input[type="text"] {
           padding: 12px; 
           border-radius: 10px; 
           font-size: 16px; 
           width: 100%; 
           margin-bottom: 15px; 
           background-color: var(--color-input-bg); 
           color: var(--color-text); 
           border: 2px solid var(--color-input-border); 
           transition: border-color 0.2s, box-shadow 0.2s;
       }
       input:focus {
           border-color: var(--color-primary);
           box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.3);
           outline: none;
       }
       input::placeholder {
            color: #a3a3a3; 
       }
       
       /* General button styling */
       .button { 
           padding: 12px 25px; 
           font-size: 18px; 
           font-weight: 700;
           border-radius: 10px; 
           transition: all 0.2s;
           box-shadow: 0 4px 10px rgba(0,0,0,0.4);
       }
       .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.5);
       }
       .button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
       }
       .btn-primary { background-color: var(--color-primary); color: var(--color-background); }
       .btn-yellow { background-color: var(--color-primary); color: var(--color-background); }
       .btn-danger { background-color: var(--color-danger); color: var(--color-text); }
       .btn-cheat { background-color: var(--color-cheat-button); color: var(--color-text); font-size: 14px; padding: 10px 15px; box-shadow: none; }
       .btn-cheat:hover { background-color: #6d28d9; transform: scale(1.02); }


       /* Language Toggle Specific Button */
       #lang-toggle-button {
           background-color: #3b82f6; 
           color: white;
           padding: 8px 15px;
           font-size: 14px;
           margin-bottom: 15px;
           box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
           border-radius: 8px;
       }
       
       .role-display {
           padding: 40px 25px; 
           margin-top: 25px;
           text-align: center; 
           background-color: var(--color-secondary); 
           border-radius: 15px;
           min-height: 140px; 
           display: flex;
           flex-direction: column;
           justify-content: center; 
           align-items: center; 
           box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
       }
       .role-text { 
           font-size: 20px; 
           font-weight: 700; 
           margin-bottom: 10px; 
           color: var(--color-initial-text); 
       }
       .word-text { 
           font-size: 32px; 
           font-weight: 900; 
           display: block; 
           color: var(--color-initial-text) !important;
       }
       
       #timer-display { 
           font-size: 2.8rem; 
           font-weight: 900;
           margin: 15px 0; 
           text-align: center; 
           color: var(--color-primary);
       }

       /* Popup styles for cheat buttons */
       #info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-card);
            border: 3px solid var(--color-primary);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.7);
            z-index: 1000;
            text-align: center;
            max-width: 90%;
       }
       #popup-close {
            background: var(--color-danger);
            color: var(--color-text);
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 700;
            transition: background-color 0.2s;
       }
       #popup-close:hover {
            background-color: #c52929;
       }
   </style>
</head>
<body id="game-body" dir="rtl">

<div class="container">
   <span id="credit-text" class="text-xs block text-center mb-4 text-gray-500">لە دروستکراوی ناسح (Naseh)</span>
   <h1 id="title">یاری فریودەر (Imposter)</h1>
   
   <hr class="border-gray-700 my-4">

    <button onclick="toggleLanguage()" id="lang-toggle-button" class="button float-left">English / کوردی</button>
   <div style="clear: both;"></div>

   <div id="setup-screen" class="text-center">
       <label for="player-count" id="players-label" class="block text-lg font-bold mb-1 mt-3"></label>
       <input type="number" id="player-count" value="4" min="3" max="12" onchange="updatePlayerInputs()">

       <label for="imposter-count" id="imposters-label" class="block text-lg font-bold mb-1"></label>
       <input type="number" id="imposter-count" value="1" min="1" max="2">
       
       <div class="flex justify-between items-center mt-3 mb-3 p-3 bg-gray-700 rounded-xl border border-gray-600">
           <label id="hint-label" class="m-0 p-0 font-bold text-gray-200 text-base"></label>
           <label class="switch">
               <input type="checkbox" id="hint-toggle" checked>
               <span class="slider"></span>
           </label>
       </div>

       <h2 id="names-title" class="text-xl"></h2>
       <div id="player-names-container">
           </div>

       <button onclick="startGame()" id="start-button" class="button btn-primary mt-4 w-full"></button>
   </div>

   <div id="role-screen" style="display: none;" class="text-center">
       <h2 id="current-player-label"></h2>
       <div id="role-display-div" class="role-display" onclick="revealRole()">
           <p id="role-status" class="role-text">...</p>
           <p id="secret-word" class="word-text">...</p>
       </div>
       <p class="text-xs mt-2 text-gray-400" id="tap-instruction">دەست لێبدە بۆ بینینی ڕۆڵەکەت / Tap to reveal your role</p>
       <button onclick="hideRole()" id="hide-button" class="button btn-primary mt-6 w-full" style="display: none;"></button>
   </div>

   <div id="clue-screen" style="display: none;">
       <h2 id="turn-title" class="text-center"></h2>
       <div id="timer-display">00:00</div>
       
       <div class="flex space-x-3 rtl:space-x-reverse mb-4">
           <button onclick="startCluePhaseTimer()" id="start-timer-button" class="button btn-yellow w-full"></button>
       </div>

       <div class="flex space-x-2 rtl:space-x-reverse mb-4">
           <button onclick="showSecretWord()" id="secret-word-cheat" class="button btn-cheat w-1/2" style="display: none;">...</button>
           <button onclick="showImposterNames()" id="imposter-name-cheat" class="button btn-cheat w-1/2" style="display: none;">...</button>
       </div>

       <p id="clue-phase-instruction" class="text-center text-sm mb-4 text-gray-400 font-medium"></p>
       
       <button onclick="showVotingScreen()" id="go-to-vote-button" class="button btn-primary w-full"></button>
       
       <h3 id="clues-header" class="text-right mt-6 text-base font-bold text-gray-400"></h3>
       <ul id="clues-list" class="list-disc pr-5 mt-2 space-y-1 rtl:pr-0 rtl:pl-5"></ul>
   </div>
   
   <div id="imposter-reveal-screen" style="display: none;">
       <h2 id="imposter-reveal-header" class="text-center text-red-500"></h2>
       <p id="imposter-reveal-message" class="text-center my-4 text-xl font-bold"></p>
       <div id="revealed-imposters" class="text-center text-3xl font-extrabold text-red-400"></div>
       <button onclick="showResultScreen(false)" id="imposter-reveal-button" class="button btn-danger mt-6 w-full"></button>
   </div>

   <div id="voting-screen" style="display: none;">
       <h2 id="vote-title" class="text-center"></h2>
       <p id="vote-instruction" class="text-center text-gray-300 mb-4"></p>
       <div id="player-votes" class="grid grid-cols-2 gap-3 mt-4">
           </div>
       </div>

   <div id="result-screen" style="display: none;">
       <h2 id="result-title" class="text-center"></h2>
       <p id="result-message" class="text-2xl font-black my-4 text-center"></p>
       
       <p id="final-imposter-reveal" class="text-xl font-bold text-red-400 text-center mt-3" style="display: none;"></p>
       <p id="final-word-reveal" class="text-xl font-bold text-yellow-400 text-center mt-2" style="display: none;"></p>
       
       <button onclick="revealFinalDetails()" id="reveal-final-button" class="button btn-yellow mt-6 w-full"></button>

       <button onclick="resetGame()" id="play-again-button" class="button btn-primary mt-3 w-full"></button>
   </div>
</div>

<div id="info-popup" style="display: none;">
    <p id="popup-content" class="text-xl font-bold mb-3"></p>
    <button id="popup-close">تەواو / Close</button>
</div>

<script>
   // Global variables for game state
   let lang = 'ku'; 
   let players = [];
   let secretWordObj = null; 
   let currentPlayerIndex = 0;
   let clues = [];

   let gameTimer = null;
   let timeRemaining = 0;
   let isCluePhaseActive = false;
   let isHintOn = true;

   // --- Language Dictionary (Word Lists) ---
   const i18n = {
       'ku': {
           title: 'یاری فریودەر (Imposter)',
           playersLabel: 'ژمارەی یاریزانان (3-12):',
           impostersLabel: 'ژمارەی فریودەران (1-2):',
           hintLabel: 'ڕێنمایی فریودەر (وشەیەکی پەیوەندیدار)',
           namesTitle: 'ناوی یاریزانەکان',
           startButton: 'دەستپێکردنی یاری',
           currentPlayerLabel: '%s، دەست لێبدە بۆ بینینی ڕۆڵەکەت',
           hideButton: 'تەواو، بیدە بە یاریزانی دواتر',
           roleCrewmate: 'تۆ یاریزانی ئاسایی. ووشەکە ئەوەیە:',
           roleImposter: 'تۆ فریودەری ❌', 
           imposterHintBase: 'وشەی پەیوەندیدار: %s', 
           turnTitle: 'قۆناغی گفتوگۆ و پێدانی ڕێنمایی',
           cluePhaseInstruction: 'ئەمە قۆناغی گفتوگۆ و پێدانی ڕێنماییە بە دەنگ. (کەسێک لە یاریزانەکان دەستپێدەکات بە ڕێکەوت)',
           goToVoteButton: 'دەستپێکردنی دەنگدان',
           startTimerButton: 'دەستپێکردنی کاتی گفتوگۆ',
           secretWordCheatButton: 'ووشە نهێنییەکە',
           imposterNameCheatButton: 'ناوی فریودەر',
           cluesHeader: 'ڕێنماییە نێردراوەکان:',
           imposterRevealHeader: 'کاتی گفتوگۆ کۆتایی هات!',
           imposterRevealMessage: 'فریودەرەکان بەهۆی تەواوبوونی کاتەوە دۆزرانەوە:',
           imposterRevealButton: 'تەواوکردنی یاری (دۆڕان)',
           voteTitle: 'قۆناغی دەنگدان: تۆمەتبارکردنی فریودەر',
           voteInstruction: 'دەست لێبدە لەسەر ئەو کەسەی کە گروپەکە دەنگی بۆ داوە.',
           resultTitle: 'یاری تەواو بوو!',
           crewmateWin: 'یاریزانە ئاساییەکان بردیانەوە! فریودەرەکان گیران.',
           imposterWin: 'فریودەرەکان بردیانەوە! بە سەرکەوتوویی یاریزانە ئاساییەکانیان فریودا.',
           finalWord: 'ووشە نهێنییەکە ئەوە بوو: %s',
           finalImposters: 'فریودەرەکان ئەمانە بوون: %s',
           revealFinalButton: 'بینینی ڕۆڵ و ووشە نهێنییەکە',
           playAgainButton: 'گەڕانەوە بۆ سەرەتا و دووبارە یاری کردنەوە',
           
           // --- KURDISH WORD LIST (Truncated for brevity) ---
           words: [
               { text: 'قەڵەم ✏️', hint: 'کاغەز', enText: 'Pen ✏️', enHint: 'Paper' },
               { text: 'سێو 🍎', hint: 'میوە', enText: 'Apple 🍎', enHint: 'Fruit' },
               { text: 'پەنجەرە 🪟', hint: 'شووشە', enText: 'Window 🪟', enHint: 'Glass' },
               { text: 'پیاو 👨', hint: 'ڕیش', enText: 'Man 👨', enHint: 'Beard' },
               { text: 'منداڵ 👶', hint: 'یاری', enText: 'Baby 👶', enHint: 'Toy' },
               { text: 'هەور ☁️', hint: 'ئاسمان', enText: 'Cloud ☁️', enHint: 'Sky' },
               { text: 'سفرە 🍽️', hint: 'نان', enText: 'Table 🍽️', enHint: 'Bread' },
               { text: 'ماسی 🐟', hint: 'ئاو', enText: 'Fish 🐟', enHint: 'Water' },
               { text: 'چیا 🏔️', hint: 'سەهۆڵ', enText: 'Mountain 🏔️', enHint: 'Snow' },
               { text: 'مۆم 🕯️', hint: 'ئاگر', enText: 'Candle 🕯️', enHint: 'Fire' },
               { text: 'شەقاوە 🛣️', hint: 'ئۆتۆمبێل', enText: 'Road 🛣️', enHint: 'Car' },
               { text: 'کۆمپیوتەر 💻', hint: 'مۆنیتۆر', enText: 'Computer 💻', enHint: 'Monitor' },
               { text: 'پەڕتووک 📕', hint: 'خوێندنەوە', enText: 'Book 📕', enHint: 'Reading' },
               { text: 'پڵنگ 🐅', hint: 'گۆشت', enText: 'Tiger 🐅', enHint: 'Meat' },
               { text: 'تۆپی پێ ⚽', hint: 'یاریگا', enText: 'Football ⚽', enHint: 'Stadium' },
               { text: 'ئەستێرە ⭐', hint: 'شەو', enText: 'Star ⭐', enHint: 'Night' },
               { text: 'ئاوێنە 🪞', hint: 'ڕووخسار', enText: 'Mirror 🪞', enHint: 'Face' },
               { text: 'ئامێر 🎹', hint: 'میوزیک', enText: 'Instrument 🎹', enHint: 'Music' },
               { text: 'بەفین 🧊', hint: 'ساردی', enText: 'Ice 🧊', enHint: 'Cold' }, 
               { text: 'باخ 🪴', hint: 'گول', enText: 'Garden 🪴', enHint: 'Flower' },
           ]
       },
       'en': {
           title: 'Imposter (Social Deduction Game)',
           playersLabel: 'Number of Players (3-12):',
           impostersLabel: 'Number of Imposters (1-2):',
           hintLabel: 'Imposter Hint (Related Word)',
           namesTitle: 'Player Names',
           startButton: 'Start Game',
           currentPlayerLabel: '%s, Tap to reveal your role',
           hideButton: 'Got it, Pass to Next Player',
           roleCrewmate: 'You are a Crewmate. The secret word is:',
           roleImposter: 'You are the Imposter ❌',
           imposterHintBase: 'Related Word: %s',
           turnTitle: 'Discussion & Clue Phase',
           cluePhaseInstruction: 'This is the phase for verbal discussion and giving clues. (A random player starts first)',
           goToVoteButton: 'Start Voting',
           startTimerButton: 'Start Discussion Timer',
           secretWordCheatButton: 'Secret Word',
           imposterNameCheatButton: 'Imposter Name',
           cluesHeader: 'Submitted Clues:',
           imposterRevealHeader: 'Discussion Time Expired!',
           imposterRevealMessage: 'The Imposters are revealed due to time running out:',
           imposterRevealButton: 'Finish Game (Bad Guys Win)',
           voteTitle: 'Voting Phase: Accuse the Imposter',
           voteInstruction: 'Tap the person the group has voted for.',
           resultTitle: 'Game Over!',
           crewmateWin: 'The Crewmates Win! The Imposters were caught.',
           imposterWin: 'The Imposters Win! They successfully tricked the Crewmates.',
           finalWord: 'The secret word was: %s',
           finalImposters: 'The Imposters were: %s',
           revealFinalButton: 'Reveal Role and Secret Word',
           playAgainButton: 'Go to Start & Play Again',

           // --- ENGLISH WORD LIST (Truncated for brevity) ---
           words: [
               { text: 'Pen ✏️', hint: 'Paper', kuText: 'قەڵەم ✏️', kuHint: 'کاغەز' },
               { text: 'Apple 🍎', hint: 'Fruit', kuText: 'سێو 🍎', kuHint: 'میوە' },
               { text: 'Window 🪟', hint: 'Glass', kuText: 'پەنجەرە 🪟', kuHint: 'شووشە' },
               { text: 'Man 👨', hint: 'Beard', kuText: 'پیاو 👨', kuHint: 'ڕیش' },
               { text: 'Baby 👶', hint: 'Toy', kuText: 'منداڵ 👶', kuHint: 'یاری' },
               { text: 'Cloud ☁️', hint: 'Sky', kuText: 'هەور ☁️', kuHint: 'ئاسمان' },
               { text: 'Table 🍽️', hint: 'Bread', kuText: 'سفرە 🍽️', kuHint: 'نان' },
               { text: 'Fish 🐟', hint: 'Water', kuText: 'ماسی 🐟', kuHint: 'ئاو' },
               { text: 'Mountain 🏔️', hint: 'Snow', kuText: 'چیا 🏔️', kuHint: 'سەهۆڵ' },
               { text: 'Candle 🕯️', hint: 'Fire', kuText: 'مۆم 🕯️', kuHint: 'ئاگر' },
               { text: 'Road 🛣️', hint: 'Car', kuText: 'شەقاوە 🛣️', kuHint: 'ئۆتۆمبێل' },
               { text: 'Computer 💻', hint: 'Monitor', kuText: 'کۆمپیوتەر 💻', kuHint: 'مۆنیتۆر' },
               { text: 'Book 📕', hint: 'Reading', kuText: 'پەڕتووک 📕', kuHint: 'خوێندنەوە' },
               { text: 'Tiger 🐅', hint: 'Meat', kuText: 'پڵنگ 🐅', kuHint: 'گۆشت' },
               { text: 'Football ⚽', hint: 'Stadium', kuText: 'تۆپی پێ ⚽', kuHint: 'یاریگا' },
               { text: 'Star ⭐', hint: 'Night', kuText: 'ئەستێرە ⭐', kuHint: 'شەو' },
               { text: 'Mirror 🪞', hint: 'Face', kuText: 'ئاوێنە 🪞', kuHint: 'ڕووخسار' },
               { text: 'Instrument 🎹', hint: 'Music', kuText: 'ئامێر 🎹', kuHint: 'میوزیک' },
               { text: 'Ice 🧊', hint: 'Cold', kuText: 'بەفین 🧊', kuHint: 'ساردی' },
               { text: 'Garden 🪴', hint: 'Flower', kuText: 'باخ 🪴', kuHint: 'گول' },
           ]
       }
   };
   
   // --- Utility Functions ---

   function getLangText(key) {
       return i18n[lang][key];
   }

   function shuffleArray(array) {
       for (let i = array.length - 1; i > 0; i--) {
           const j = Math.floor(Math.random() * (i + 1));
           [array[i], array[j]] = [array[j], array[i]];
       }
   }

   function switchDirection(newLang) {
       const body = document.getElementById('game-body');
       if (newLang === 'ku') {
           body.dir = 'rtl';
           body.classList.remove('lang-en');
       } else {
           body.dir = 'ltr';
           body.classList.add('lang-en');
       }
   }
   
   function toggleLanguage() {
       lang = lang === 'ku' ? 'en' : 'ku';
       switchDirection(lang);
       updateUI();
   }

   function updateUI() {
       document.getElementById('main-title').textContent = getLangText('title');
       document.getElementById('title').textContent = getLangText('title');
       document.getElementById('players-label').textContent = getLangText('playersLabel');
       document.getElementById('imposters-label').textContent = getLangText('impostersLabel');
       document.getElementById('hint-label').textContent = getLangText('hintLabel');
       document.getElementById('names-title').textContent = getLangText('namesTitle');
       document.getElementById('start-button').textContent = getLangText('startButton');
       
       document.getElementById('turn-title').textContent = getLangText('turnTitle');
       document.getElementById('start-timer-button').textContent = getLangText('startTimerButton');
       document.getElementById('clue-phase-instruction').textContent = getLangText('cluePhaseInstruction');
       document.getElementById('go-to-vote-button').textContent = getLangText('goToVoteButton');
       document.getElementById('clues-header').textContent = getLangText('cluesHeader');

       const secretWordCheatButton = document.getElementById('secret-word-cheat');
       const imposterNameCheatButton = document.getElementById('imposter-name-cheat');
       secretWordCheatButton.textContent = getLangText('secretWordCheatButton');
       imposterNameCheatButton.textContent = getLangText('imposterNameCheatButton');

       document.getElementById('imposter-reveal-header').textContent = getLangText('imposterRevealHeader');
       document.getElementById('imposter-reveal-message').textContent = getLangText('imposterRevealMessage');
       document.getElementById('imposter-reveal-button').textContent = getLangText('imposterRevealButton');

       document.getElementById('vote-title').textContent = getLangText('voteTitle');
       document.getElementById('vote-instruction').textContent = getLangText('voteInstruction');
       
       document.getElementById('result-title').textContent = getLangText('resultTitle');
       document.getElementById('reveal-final-button').textContent = getLangText('revealFinalButton');
       document.getElementById('play-again-button').textContent = getLangText('playAgainButton');

       updatePlayerInputs(true);
   }

   function updatePlayerInputs(isLanguageUpdate = false) {
       const playerCount = parseInt(document.getElementById('player-count').value);
       const container = document.getElementById('player-names-container');
       
       const existingInputs = container.querySelectorAll('input[type="text"]');
       const currentNames = Array.from(existingInputs).map(input => input.value);
       
       container.innerHTML = ''; 

       for (let i = 1; i <= playerCount; i++) {
           const input = document.createElement('input');
           input.type = 'text';
           input.id = `player-name-${i}`;
           
           const genericNameKu = `یاریزان ${i}`;
           const genericNameEn = `Player ${i}`;
           const defaultName = lang === 'ku' ? genericNameKu : genericNameEn;
           const placeholderName = lang === 'ku' ? `ناوی یاریزانی ${i}` : `Player ${i}'s Name`;
           input.placeholder = placeholderName;

           let nameToUse = defaultName;

           if (currentNames.length >= i) {
               const savedName = currentNames[i - 1];
               const isGenericKu = savedName === `یاریزان ${i}` || savedName === `یاریزان ${i-1}`;
               const isGenericEn = savedName === `Player ${i}` || savedName === `Player ${i-1}`;
               
               if (isLanguageUpdate && (isGenericKu || isGenericEn)) {
                   nameToUse = defaultName;
               } else {
                   nameToUse = savedName;
               }
           }
           
           input.value = nameToUse;
           container.appendChild(input);
       }
       
       timeRemaining = playerCount * 60;
       updateTimerDisplay();
   }

   function updateTimerDisplay() {
       const minutes = Math.floor(timeRemaining / 60);
       const seconds = timeRemaining % 60;
       document.getElementById('timer-display').textContent =
           `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
   }
   
   function startCluePhaseTimer() {
       if (gameTimer || isCluePhaseActive) return;
       
       isCluePhaseActive = true;
       document.getElementById('start-timer-button').style.display = 'none';
       
       // Show cheat buttons when the timer starts
       document.getElementById('secret-word-cheat').style.display = 'block';
       document.getElementById('imposter-name-cheat').style.display = 'block';

       document.getElementById('go-to-vote-button').style.display = 'block';

       gameTimer = setInterval(() => {
           timeRemaining--;
           updateTimerDisplay();

           if (timeRemaining <= 0) {
               clearInterval(gameTimer);
               gameTimer = null;
               isCluePhaseActive = false;
               document.getElementById('secret-word-cheat').style.display = 'none';
               document.getElementById('imposter-name-cheat').style.display = 'none';
               
               const timerDisplay = document.getElementById('timer-display');
               timerDisplay.style.color = 'var(--color-danger)'; 
               timerDisplay.textContent = lang === 'ku' ? 'کاتی تەواو بوو!' : 'Time Expired!'; 
               
               document.getElementById('go-to-vote-button').style.display = 'none';
               
               showImposterRevealScreen();
           }
       }, 1000);
   }

   // --- HOST CHEAT BUTTONS ---
   function showPopup(content) {
        document.getElementById('popup-content').innerHTML = content;
        document.getElementById('info-popup').style.display = 'block';
        document.getElementById('popup-close').onclick = () => {
            document.getElementById('info-popup').style.display = 'none';
        };
   }

   function showSecretWord() {
        const currentWord = lang === 'ku' ? secretWordObj.text : secretWordObj.enText;
        const currentHint = lang === 'ku' ? secretWordObj.hint : secretWordObj.enHint;

        const content = `
            <p style="color: var(--color-primary); font-size: 24px;">${currentWord}</p>
            <p style="color: var(--color-text); font-size: 16px; margin-top: 10px;">(${getLangText('imposterHintBase').replace('%s', currentHint)})</p>
        `;
        showPopup(content);
   }

   function showImposterNames() {
        const badGuys = players.filter(p => p.role === 'Imposter').map(p => p.name);
        const separator = lang === 'ku' ? ' و ' : ' and ';
        const content = `
            <p style="color: var(--color-danger-subtle); font-size: 20px;">${badGuys.join(separator)}</p>
        `;
        showPopup(content);
   }
   // --------------------------

   function startGame() {
       const playerCount = parseInt(document.getElementById('player-count').value);
       const imposterCount = parseInt(document.getElementById('imposter-count').value);
       isHintOn = document.getElementById('hint-toggle').checked;
       
       if (playerCount < 3 || playerCount > 12 || imposterCount < 1 || imposterCount >= playerCount) {
           alert(lang === 'ku' ? "ژمارەی یاریزان/فریودەر هەڵەیە. دڵنیابە لەوەی کە 3-12 یاریزان و 1 تا ژمارەیەک کەمتر لە یاریزانان لە ڕۆڵی فریودەردان." : "Invalid player/imposter count. Ensure 3-12 players, and 1 or more imposters (but less than total players).");
           return;
       }

       // 1. Gather Names and Assign Crewmate by default
       players = []; 
       for (let i = 1; i <= playerCount; i++) {
           const nameInput = document.getElementById(`player-name-${i}`);
           const name = nameInput.value.trim() || (lang === 'ku' ? `یاریزان ${i}` : `Player ${i}`);
           players.push({ id: i, name: name, role: 'Crewmate', votes: 0 });
       }

       // 2. Assign Imposters
       let availableIndices = Array.from({ length: playerCount }, (_, i) => i);
       shuffleArray(availableIndices); 
       
       for (let i = 0; i < imposterCount; i++) {
           const index = availableIndices.pop();
           players[index].role = 'Imposter';
       }
       
       // 3. SHUFFLE PLAYERS (Random Starter Order)
       shuffleArray(players);

       // 4. Select Word
       const words = i18n[lang].words; // Use the word list for the currently selected language
       if (words.length === 0) {
            alert(lang === 'ku' ? "پێویستە لیستی وشەکان پڕ بکرێتەوە بۆ دەستپێکردنی یاری!" : "The word list must be populated to start the game!");
            return;
       }
       
       const randomIndex = Math.floor(Math.random() * words.length);
       // Ensure secretWordObj stores all language variants
       secretWordObj = i18n['ku'].words[randomIndex]; 
       
       timeRemaining = playerCount * 60;
       updateTimerDisplay();
       
       currentPlayerIndex = 0;
       clues = [];
       document.getElementById('setup-screen').style.display = 'none';
       document.getElementById('credit-text').style.display = 'none'; 
       document.getElementById('lang-toggle-button').style.display = 'none';
       
       document.getElementById('secret-word-cheat').style.display = 'none';
       document.getElementById('imposter-name-cheat').style.display = 'none';

       showRoleScreen();
   }

   function showRoleScreen() {
       document.getElementById('role-screen').style.display = 'block';
       document.getElementById('clue-screen').style.display = 'none';
       document.getElementById('voting-screen').style.display = 'none';
       document.getElementById('result-screen').style.display = 'none';
       document.getElementById('imposter-reveal-screen').style.display = 'none';

       const player = players[currentPlayerIndex];
       
       document.getElementById('current-player-label').innerHTML = getLangText('currentPlayerLabel').replace('%s', `<strong>${player.name}</strong>`);
       
       document.getElementById('role-status').style.color = 'var(--color-initial-text)';
       document.getElementById('secret-word').style.color = 'var(--color-initial-text)';
       
       document.getElementById('role-status').textContent = '...';
       document.getElementById('secret-word').textContent = '...';
       document.getElementById('tap-instruction').style.display = 'block';
       
       const hideButton = document.getElementById('hide-button');
       hideButton.textContent = getLangText('hideButton');
       hideButton.style.display = 'none'; 
       
       const roleDisplayDiv = document.getElementById('role-display-div');
       roleDisplayDiv.onclick = revealRole;
       roleDisplayDiv.style.cursor = 'pointer'; 
   }

   function revealRole() {
       const player = players[currentPlayerIndex];
       const roleStatus = document.getElementById('role-status');
       const secretWord = document.getElementById('secret-word');
       document.getElementById('tap-instruction').style.display = 'none';

       // Select the correct language word/hint from the multi-language secretWordObj
       const currentWord = lang === 'ku' ? secretWordObj.text : secretWordObj.enText;
       const currentHint = lang === 'ku' ? secretWordObj.hint : secretWordObj.enHint;


       if (player.role === 'Crewmate') {
           roleStatus.textContent = getLangText('roleCrewmate');
           secretWord.textContent = currentWord;
           roleStatus.style.color = 'var(--color-success)';
           secretWord.style.color = 'var(--color-primary)';
       } else if (player.role === 'Imposter') {
           roleStatus.textContent = getLangText('roleImposter'); 
           
           if (isHintOn) {
               secretWord.textContent = getLangText('imposterHintBase').replace('%s', currentHint);
           } else {
                secretWord.textContent = lang === 'ku' ? 'هیچ ڕێنمایییەک نییە' : 'No Hint Available';
           }
           roleStatus.style.color = 'var(--color-danger)'; 
           secretWord.style.color = 'var(--color-text)'; 
       }


       document.getElementById('hide-button').style.display = 'block';
       
       const roleDisplayDiv = document.getElementById('role-display-div');
       roleDisplayDiv.onclick = null;
       roleDisplayDiv.style.cursor = 'default';
   }

   function hideRole() {
       currentPlayerIndex++;
       if (currentPlayerIndex < players.length) {
           showRoleScreen();
       } else {
           currentPlayerIndex = 0; 
           showClueScreen();
       }
   }

   function showClueScreen() {
       document.getElementById('role-screen').style.display = 'none';
       document.getElementById('clue-screen').style.display = 'block';
       
       document.getElementById('go-to-vote-button').style.display = 'block';
       
       document.getElementById('timer-display').style.color = 'var(--color-primary)';
       if (!isCluePhaseActive) {
           document.getElementById('start-timer-button').style.display = 'block';
           document.getElementById('secret-word-cheat').style.display = 'none';
           document.getElementById('imposter-name-cheat').style.display = 'none';
           document.getElementById('timer-display').textContent = `${String(Math.floor(timeRemaining / 60)).padStart(2, '0')}:${String(timeRemaining % 60).padStart(2, '0')}`;
       } else {
           document.getElementById('start-timer-button').style.display = 'none';
           document.getElementById('secret-word-cheat').style.display = 'block';
           document.getElementById('imposter-name-cheat').style.display = 'block';
       }

       // updateCluesList(); // function currently empty
   }
   
   function showImposterRevealScreen() {
        clearInterval(gameTimer);
        gameTimer = null;
        isCluePhaseActive = false;
        
        document.getElementById('clue-screen').style.display = 'none';
        document.getElementById('imposter-reveal-screen').style.display = 'block';
        
        const badGuys = players.filter(p => p.role === 'Imposter').map(p => p.name);
        const separator = lang === 'ku' ? ' و ' : ' and ';
        document.getElementById('revealed-imposters').textContent = badGuys.join(separator);
        
        document.getElementById('imposter-reveal-button').onclick = () => showResultScreen(false);
   }


   function showVotingScreen() {
       clearInterval(gameTimer);
       gameTimer = null;
       isCluePhaseActive = false;
       
       document.getElementById('secret-word-cheat').style.display = 'none';
       document.getElementById('imposter-name-cheat').style.display = 'none';
       
       document.getElementById('clue-screen').style.display = 'none';
       document.getElementById('voting-screen').style.display = 'block';

       const voteDiv = document.getElementById('player-votes');
       voteDiv.innerHTML = '';
       
       players.forEach(player => {
           const button = document.createElement('button');
           button.textContent = player.name; 
           button.onclick = () => recordVote(player.id, player.name); 
           button.classList.add('button', 'btn-danger', 'text-xl', 'font-bold');
           voteDiv.appendChild(button);
       });
   }

   function recordVote(votedPlayerId, votedPlayerName) {
       // Single-tap confirmation logic
       const accusedPlayer = players.find(p => p.id === votedPlayerId);
       const isBadGuy = accusedPlayer.role === 'Imposter';
       
       showResultScreen(isBadGuy); 
   }

   function revealFinalDetails() {
        const badGuys = players.filter(p => p.role === 'Imposter').map(p => p.name);
        const separator = lang === 'ku' ? ' و ' : ' and ';
        const badGuyNames = badGuys.join(separator);

        const currentWord = lang === 'ku' ? secretWordObj.text : secretWordObj.enText;

        document.getElementById('final-imposter-reveal').textContent = getLangText('finalImposters').replace('%s', badGuyNames);
        document.getElementById('final-word-reveal').textContent = getLangText('finalWord').replace('%s', currentWord);
        
        document.getElementById('final-imposter-reveal').style.display = 'block';
        document.getElementById('final-word-reveal').style.display = 'block';
        document.getElementById('reveal-final-button').style.display = 'none';
   }

   function showResultScreen(crewmateWin) {
       document.getElementById('voting-screen').style.display = 'none';
       document.getElementById('imposter-reveal-screen').style.display = 'none'; 
       document.getElementById('result-screen').style.display = 'block';
       
       const messageElement = document.getElementById('result-message');
       messageElement.style.color = ''; // Reset color
       
       document.getElementById('final-imposter-reveal').style.display = 'none';
       document.getElementById('final-word-reveal').style.display = 'none';
       document.getElementById('reveal-final-button').style.display = 'block';


       if (crewmateWin) {
           document.getElementById('result-title').textContent = getLangText('resultTitle');
           messageElement.textContent = getLangText('crewmateWin');
           messageElement.style.color = 'var(--color-success)';
       } else {
           document.getElementById('result-title').textContent = getLangText('resultTitle');
           messageElement.textContent = getLangText('imposterWin');
           messageElement.style.color = 'var(--color-danger)';
       }
   }

   function resetGame() {
       document.getElementById('setup-screen').style.display = 'block';
       document.getElementById('result-screen').style.display = 'none';
       document.getElementById('credit-text').style.display = 'block'; 
       document.getElementById('lang-toggle-button').style.display = 'block';
       
       clearInterval(gameTimer);
       gameTimer = null;
       timeRemaining = 0;
       isCluePhaseActive = false;
       players = []; 
       clues = [];
       updatePlayerInputs(); 
       updateUI(); 
   }

   // Initialize the app on load
   window.onload = function() {
       switchDirection(lang);
       updatePlayerInputs();
       updateUI();
   }
</script>

</body>
</html>
